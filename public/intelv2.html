<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence Dashboard - Epilepsy Neurostimulation</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Custom styles -->
    <style>
        :root {
            --marcomm-orange: #FF6B35;
            --marcomm-orange-light: #FF8B5F;
            --marcomm-orange-dark: #E55A24;
            --marcomm-dark: #1E293B;
        }
        
        .text-marcomm-orange { color: var(--marcomm-orange); }
        .text-marcomm-orange-light { color: var(--marcomm-orange-light); }
        .text-marcomm-orange-dark { color: var(--marcomm-orange-dark); }
        .text-marcomm-dark { color: var(--marcomm-dark); }
        
        .bg-marcomm-orange { background-color: var(--marcomm-orange); }
        .bg-marcomm-orange-light { background-color: var(--marcomm-orange-light); }
        .bg-marcomm-orange-dark { background-color: var(--marcomm-orange-dark); }
        .bg-marcomm-dark { background-color: var(--marcomm-dark); }
        
        .border-marcomm-orange { border-color: var(--marcomm-orange); }
        
        .dashboard-refreshing {
            animation: pulse-bg 1.5s ease-in-out;
        }
        
        @keyframes pulse-bg {
            0% { background-color: transparent; }
            50% { background-color: rgba(255, 107, 53, 0.05); }
            100% { background-color: transparent; }
        }
        
        .dashboard-section {
            transition: opacity 0.3s ease-in-out;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            #printable-report, #printable-report * {
                visibility: visible;
            }
            
            #printable-report {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- Dashboard Header -->
    <header class="bg-marcomm-dark shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-white">Market Intelligence Dashboard</h1>
                    <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-md bg-marcomm-orange text-white">Epilepsy Neurostimulation</span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Dashboard search -->
                    <div class="relative">
                        <input id="dashboard-search" type="text" placeholder="Search dashboard..." class="w-48 pl-10 pr-4 py-2 text-sm bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-marcomm-orange focus:border-transparent text-white">
                        <div class="absolute left-3 top-2.5 text-gray-400">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    
                    <!-- Dark mode toggle -->
                    <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-700 focus:outline-none" aria-label="Toggle dark mode">
                        <i class="fas fa-moon text-gray-300"></i>
                    </button>
                    
                    <!-- Refresh data -->
                    <button id="refreshData" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-marcomm-orange rounded-md hover:bg-marcomm-orange-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-marcomm-orange transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
            
            <!-- Connection status -->
            <div class="flex items-center mt-2">
                <div id="status-indicator" class="h-2 w-2 rounded-full bg-yellow-500 mr-2 animate-pulse"></div>
                <span id="status-text" class="text-xs text-gray-300">Loading...</span>
                <span class="mx-2 text-xs text-gray-500">|</span>
                <span class="text-xs text-gray-400">Last updated: <span id="last-updated">Loading...</span></span>
            </div>
            
            <!-- Dashboard navigation -->
            <nav class="mt-4">
                <ul class="flex space-x-1 overflow-x-auto pb-1">
                    <li><a href="#market-overview" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="market-overview">Overview</a></li>
                    <li><a href="#competitive-map" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="competitive-map">Competitors</a></li>
                    <li><a href="#patient-journey" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="patient-journey">Patient Journey</a></li>
                    <li><a href="#market-penetration" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="market-penetration">Market Penetration</a></li>
                    <li><a href="#early-stage-competitors" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="early-stage-competitors">Early-Stage Competitors</a></li>
                    <li><a href="#regulatory-landscape" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="regulatory-landscape">Regulatory</a></li>
                    <li><a href="#provider-geography" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="provider-geography">Geography</a></li>
                    <li><a href="#strategic-recommendations" class="dashboard-nav-item px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-md transition-colors" data-target="strategic-recommendations">Strategy</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Main dashboard container -->
    <main id="dashboard-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Dashboard sections -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Market Overview -->
            <section id="market-overview" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Market Overview</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Overall epilepsy neurostimulation market metrics</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center p-12">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading data</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Overview stats -->
                        <div id="overview-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </section>
            
            <!-- Competitor Map -->
            <section id="competitive-map" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Competitive Map</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Key competitors in the epilepsy treatment space</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center p-12">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading data</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Competitor list -->
                        <ul id="competitor-list" class="space-y-2 mt-2"></ul>
                    </div>
                </div>
            </section>
            
            <!-- Quick Stats -->
            <section id="quick-stats-section" class="dashboard-section lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Quick Stats</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Key metrics at a glance</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center p-12">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading data</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Quick stats -->
                        <div id="quick-stats" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </section>
            
            <!-- Market Share Chart -->
            <section id="market-share-section" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Market Share</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Distribution of market share by competitor</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Market share chart -->
                        <canvas id="market-share-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Financial Radar Chart -->
            <section id="financial-radar-section" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Financial Metrics</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Key financial indicators by competitor</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Financial radar chart -->
                        <canvas id="financial-radar-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- FDA Metrics Chart -->
            <section id="fda-metrics-section" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">FDA Metrics</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Regulatory approvals and submissions</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- FDA metrics chart -->
                        <canvas id="fda-metrics-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Patents Chart -->
            <section id="patents-section" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Patents</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Intellectual property by competitor</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Patents chart -->
                        <canvas id="patents-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- Implantation Trends Chart -->
            <section id="implantation-trends-section" class="dashboard-section lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Implantation Trends</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Historical procedure volume by competitor</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Implantation trends chart -->
                        <canvas id="implantation-trends-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>
            
            <!-- CPT Code Distribution -->
            <section id="cpt-code-distribution-section" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">CPT Code Distribution</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Procedure codes by competitor</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- CPT code distribution chart -->
                        <div id="cpt-code-distribution" class="w-full h-full"></div>
                    </div>
                </div>
            </section>
            
            <!-- Provider Distribution -->
            <section id="provider-distribution-section" class="dashboard-section lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Provider Distribution</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Healthcare providers by competitor</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6 h-80">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center h-full">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error message -->
                        <div class="chart-error hidden text-center h-full flex flex-col items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-lg text-red-500">Error loading chart</p>
                            <p class="text-sm text-gray-500 mt-2"><span>Please try refreshing the dashboard</span></p>
                        </div>
                        
                        <!-- Provider distribution chart -->
                        <div id="provider-distribution" class="w-full h-full"></div>
                    </div>
                </div>
            </section>
            
            <!-- Competitive Insights -->
            <section id="competitive-insights" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Competitive Insights</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Strategic analysis of competitive landscape</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Competitive insights will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Patient Journey -->
            <section id="patient-journey" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Epilepsy Patient Journey</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Visualization of patient pathway to treatment</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Patient journey will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Market Penetration -->
            <section id="market-penetration" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Market Penetration Analysis</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Addressable market opportunity and current penetration</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Market penetration will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Early Stage Competitors -->
            <section id="early-stage-competitors" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Early-Stage Competitors</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Emerging players in the epilepsy treatment space</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Early stage competitors will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Regulatory Landscape -->
            <section id="regulatory-landscape" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Regulatory Landscape</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">FDA pathways and reimbursement analysis</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Regulatory landscape will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Provider Geography -->
            <section id="provider-geography" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Provider Geographic Distribution</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Regional analysis of healthcare providers</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Provider geography will be rendered here -->
                    </div>
                </div>
            </section>
            
            <!-- Strategic Recommendations -->
            <section id="strategic-recommendations" class="dashboard-section lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-marcomm-dark dark:text-white">Strategic Recommendations</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">Market entry and growth strategies</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <!-- Loading indicator -->
                        <div class="loader-container flex items-center justify-center p-12">
                            <div class="inline-block relative w-16 h-16">
                                <div class="absolute top-0 left-0 w-full h-full">
                                    <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Strategic recommendations will be rendered here -->
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Printable Report (hidden until needed) -->
        <div id="printable-report" class="hidden"></div>
    </main>
    
    <!-- Dashboard Footer -->
    <footer id="dashboard-footer" class="mt-6">
        <!-- Footer content will be rendered by JavaScript -->
    </footer>
    
  
    <!-- JavaScript -->
     <script>
// Enhanced Market Intelligence Dashboard with Advanced Visualizations
// Fixes loading indicator issue and adds useful visualizations based on client requirements

// Simple safe console logging
function logInfo(message, data) {
    console.log(message, data || '');
}

function logError(message, error) {
    console.error(message, error || '');
}

// Basic DOM helpers
function getElement(id) {
    return document.getElementById(id);
}

function showLoading(id) {
    const container = getElement(id);
    if (!container) return;
    
    const loader = container.querySelector('.loader-container');
    if (loader) {
        loader.classList.remove('hidden');
    }
}

function hideLoading(id) {
    const container = getElement(id);
    if (!container) return;
    
    const loader = container.querySelector('.loader-container');
    if (loader) {
        loader.classList.add('hidden');
    }
}

function removeLoadingIndicators() {
    // Remove all loading indicators
    document.querySelectorAll('.loader-container').forEach(loader => {
        loader.classList.add('hidden');
    });
    
    // Also remove any loading animation classes that might be on other elements
    document.querySelectorAll('.animate-spin, .animate-pulse').forEach(element => {
        element.classList.remove('animate-spin', 'animate-pulse');
    });
}

function showError(id, message) {
    const container = getElement(id);
    if (!container) return;
    
    const errorContainer = container.querySelector('.chart-error, .insights-error');
    if (errorContainer) {
        const messageSpan = errorContainer.querySelector('span');
        if (messageSpan) {
            messageSpan.textContent = message || 'Error loading data';
        }
        errorContainer.classList.remove('hidden');
    }
}

function hideError(id) {
    const container = getElement(id);
    if (!container) return;
    
    const errorContainer = container.querySelector('.chart-error, .insights-error');
    if (errorContainer) {
        errorContainer.classList.add('hidden');
    }
}

// Formatting helpers
function formatNumber(number, decimals = 0) {
    if (number === undefined || number === null) return 'N/A';
    
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(number);
}

function formatCurrency(number, decimals = 0) {
    if (number === undefined || number === null) return 'N/A';
    
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(number);
}

function formatPercent(number, decimals = 1) {
    if (number === undefined || number === null) return 'N/A';
    
    return new Intl.NumberFormat('en-US', {
        style: 'percent',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(number / 100);
}

// Update connection status
function updateConnectionStatus(status) {
    const indicator = getElement('status-indicator');
    const text = getElement('status-text');
    
    if (!indicator || !text) return;
    
    switch (status) {
        case 'connected':
            indicator.className = 'h-2 w-2 rounded-full bg-green-500 mr-2';
            text.textContent = 'Connected';
            text.className = 'text-xs text-gray-300';
            break;
        case 'disconnected':
            indicator.className = 'h-2 w-2 rounded-full bg-red-500 mr-2';
            text.textContent = 'Disconnected';
            text.className = 'text-xs text-red-500';
            break;
        case 'loading':
            indicator.className = 'h-2 w-2 rounded-full bg-yellow-500 mr-2 animate-pulse';
            text.textContent = 'Loading...';
            text.className = 'text-xs text-gray-300';
            break;
    }
}

// Initialize dashboard on load
document.addEventListener('DOMContentLoaded', function() {
    // Set up dark mode toggle
    setupDarkMode();
    
    // Configure global Chart.js settings for better dark mode support
    configureChartDefaults();
    
    // Load dashboard data once
    loadDashboardData();
    
    // Attach refresh event listener
    const refreshButton = getElement('refreshData');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            loadDashboardData();
        });
    }
});

// Configure Chart.js global defaults for better styling
function configureChartDefaults() {
    if (typeof Chart === 'undefined') {
        logError('Chart.js not loaded');
        return;
    }
    
    // Set global defaults for all charts
    Chart.defaults.font.family = "'system-ui', '-apple-system', 'sans-serif'";
    Chart.defaults.color = '#B8C2CC'; // Light gray for dark mode
    Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.1)'; // Subtle grid lines for dark mode
    Chart.defaults.scale.ticks.color = '#B8C2CC'; // Light gray for axis ticks
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(30, 41, 59, 0.9)'; // Dark blue tooltip
    Chart.defaults.plugins.tooltip.titleColor = '#FFFFFF';
    Chart.defaults.plugins.tooltip.bodyColor = '#FFFFFF';
    Chart.defaults.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.2)';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.padding = 12;
    Chart.defaults.plugins.tooltip.cornerRadius = 4;
    Chart.defaults.plugins.legend.labels.color = '#B8C2CC';
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    
    // Additional customizations for tooltip
    Chart.Tooltip.positioners.cursor = function(chartElements, coordinates) {
        return {
            x: coordinates.x,
            y: coordinates.y
        };
    };
}

// Set up dark mode toggle
function setupDarkMode() {
    const darkModeToggle = getElement('darkModeToggle');
    const html = document.documentElement;
    
    if (!darkModeToggle) return;
    
    // Check for saved preference or system preference
    const darkMode = localStorage.getItem('darkMode') === 'true' || 
                    (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    if (darkMode) {
        html.classList.add('dark');
    }
    
    // Add toggle functionality
    darkModeToggle.addEventListener('click', function() {
        html.classList.toggle('dark');
        localStorage.setItem('darkMode', html.classList.contains('dark'));
        
        // Re-render all charts with new theme
        if (window.dashboardData) {
            renderCharts(window.dashboardData);
        }
    });
}

// Main function to load all dashboard data
async function loadDashboardData() {
    logInfo('Loading dashboard data...');
    updateConnectionStatus('loading');
    
    // Show loading indicators
    document.querySelectorAll('.loader-container').forEach(loader => {
        loader.classList.remove('hidden');
    });
    
    try {
        // Make single request to get the device data
        const response = await fetch('/api/dashboard/devices');
        
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }
        
        const data = await response.json();
        logInfo('Successfully fetched dashboard data:', data);
        
        // Store data globally for reuse
        window.dashboardData = data;
        
        // Update connection status
        updateConnectionStatus('connected');
        
        // Update last updated timestamp
        const lastUpdated = getElement('last-updated');
        if (lastUpdated) {
            lastUpdated.textContent = new Date().toLocaleString();
        }
        
        // Render all sections using the data
        renderAllSections(data);
        
        // IMPORTANT: Remove all loading indicators after everything is rendered
        setTimeout(() => {
            removeLoadingIndicators();
        }, 500);
    } catch (error) {
        logError('Error loading dashboard data:', error);
        updateConnectionStatus('disconnected');
        
        // Show error message in all sections
        document.querySelectorAll('.loader-container').forEach(loader => {
            loader.classList.add('hidden');
        });
        
        document.querySelectorAll('.chart-error, .insights-error').forEach(errorEl => {
            const messageEl = errorEl.querySelector('span');
            if (messageEl) {
                messageEl.textContent = 'Failed to load data from server';
            }
            errorEl.classList.remove('hidden');
        });
    }
}

// Render all dashboard sections
function renderAllSections(data) {
    // Render Market Overview
    renderMarketOverview(data);
    
    // Render Competitive Map
    renderCompetitiveMap(data);
    
    // Render Quick Stats
    renderQuickStats(data);
    
    // Render all charts
    renderCharts(data);
    
    // Render Competitive Insights
    renderCompetitiveInsights(data);
    
    // Render Patient Journey (new visualization based on call transcript)
    renderPatientJourney(data);
    
    // Render Market Penetration (new visualization based on call transcript)
    renderMarketPenetration(data);
    
    // IMPORTANT: Remove all loading indicators after everything is rendered
    setTimeout(() => {
        removeLoadingIndicators();
    }, 500);
}

// Render Market Overview section
function renderMarketOverview(data) {
    logInfo('Rendering Market Overview...');
    hideLoading('market-overview');
    
    try {
        if (!data || !data.marketTrends) {
            throw new Error('No market data available');
        }
        
        const overviewStats = getElement('overview-stats');
        if (!overviewStats) {
            throw new Error('Overview stats element not found');
        }
        
        const marketTrends = data.marketTrends;
        const totalImplantations = marketTrends.implantations.total;
        const avgReimbursement = marketTrends.reimbursement.average;
        const cagr = marketTrends.implantations.cagr;
        const totalMarketValue = totalImplantations * avgReimbursement;
        
        // Calculate total addressable market (TAM) - assuming 1% of total U.S. population (~330M) has epilepsy,
        // and 30% of those are refractory (numbers from transcript context)
        const epilepsyPopulation = 3300000; // 1% of 330M
        const refractoryPopulation = epilepsyPopulation * 0.3; // 30% of epilepsy patients
        const marketPenetration = totalImplantations / refractoryPopulation * 100;
        
        overviewStats.innerHTML = `
            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-marcomm-orange bg-opacity-20 text-marcomm-orange">
                        <i class="fas fa-hospital-user text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Total Implantations</p>
                        <p class="text-2xl font-semibold text-marcomm-dark dark:text-white">${formatNumber(totalImplantations)}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">~${formatNumber(marketPenetration, 1)}% of refractory patients</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-500 bg-opacity-20 text-blue-500 dark:text-blue-400">
                        <i class="fas fa-dollar-sign text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Avg Reimbursement</p>
                        <p class="text-2xl font-semibold text-marcomm-dark dark:text-white">${formatCurrency(avgReimbursement)}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Per procedure</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 card">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-500 bg-opacity-20 text-green-500 dark:text-green-400">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600 dark:text-gray-300">Market Size</p>
                        <p class="text-2xl font-semibold text-marcomm-dark dark:text-white">${formatCurrency(totalMarketValue, 0)}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">CAGR: ${cagr !== undefined ? formatNumber(cagr, 2) + '%' : 'N/A'}</p>
                    </div>
                </div>
            </div>
        `;
        
        logInfo('Market Overview rendered successfully');
    } catch (error) {
        logError('Error rendering Market Overview:', error);
        showError('market-overview', error.message);
    }
}

// Render Competitive Map section with enhanced UI
function renderCompetitiveMap(data) {
    logInfo('Rendering Competitive Map...');
    hideLoading('competitive-map');
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No competitor data available');
        }
        
        const competitorList = getElement('competitor-list');
        if (!competitorList) {
            throw new Error('Competitor list element not found');
        }
        
        const competitors = data.competitors;
        logInfo('Competitors:', competitors);
        
        // Enhanced competitor list with more detail and better styling
        let listHtml = '';
        competitors.forEach(comp => {
            const name = comp.name || 'Unknown';
            const treatment = comp.treatment || 'Unknown Treatment';
            const implantations = comp.implantations?.total || 0;
            const marketShare = data.marketTrends.marketShares[name]?.total || 0;
            
            // Determine icon and color based on treatment type
            let icon = 'fa-microchip';
            let colorClass = 'text-blue-500';
            
            if (treatment.toLowerCase().includes('vagus')) {
                icon = 'fa-bolt';
                colorClass = 'text-yellow-500';
            } else if (treatment.toLowerCase().includes('brain')) {
                icon = 'fa-brain';
                colorClass = 'text-green-500';
            } else if (treatment.toLowerCase().includes('responsive')) {
                icon = 'fa-heartbeat';
                colorClass = 'text-purple-500';
            }
            
            listHtml += `
                <li class="mb-3 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md dark:shadow-none transition-all duration-200 cursor-pointer overflow-hidden group">
                    <div class="p-3 border-l-4 border-marcomm-orange">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 mr-3">
                                <i class="fas ${icon} ${colorClass} text-lg group-hover:text-white"></i>
                            </div>
                            <div class="flex-1">
                                <span class="font-medium text-marcomm-dark dark:text-white block">${name}</span>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-300 block">${treatment}</span>
                                    <span class="text-sm font-medium text-marcomm-orange">${formatNumber(marketShare, 1)}% share</span>
                                </div>
                                
                                <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5 mt-2">
                                    <div class="bg-marcomm-orange h-1.5 rounded-full" style="width: ${marketShare}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            `;
        });
        
        competitorList.innerHTML = listHtml;
        
        // Add tooltips to competitor list items
        const tooltipOptions = {
            placement: 'right',
            trigger: 'hover',
            html: true
        };
        
        // Add click event listeners to competitors
        const listItems = competitorList.querySelectorAll('li');
        competitors.forEach((comp, index) => {
            const item = listItems[index];
            if (item) {
                item.addEventListener('click', () => {
                    window.location.href = `/competitor-details.html?name=${encodeURIComponent(comp.name)}`;
                });
                
                // Add tooltip with additional information
                const tooltip = `
                    <div class="p-2">
                        <div class="font-bold mb-1">${comp.name}</div>
                        <div class="text-xs mb-1">${comp.treatment}</div>
                        <hr class="my-1 border-gray-300">
                        <div class="grid grid-cols-2 gap-1 text-xs">
                            <div>Implantations:</div>
                            <div class="text-right">${formatNumber(comp.implantations?.total || 0)}</div>
                            <div>Reimbursement:</div>
                            <div class="text-right">${formatCurrency(comp.reimbursement?.average || 0)}</div>
                            <div>Providers:</div>
                            <div class="text-right">${formatNumber(comp.providers?.unique || 0)}</div>
                        </div>
                        <div class="text-xs text-center mt-1 italic">Click for details</div>
                    </div>
                `;
                
                // Use title attribute for basic tooltip
                item.setAttribute('title', `${comp.name}: ${formatNumber(comp.implantations?.total || 0)} implantations`);
                
                // For better tooltips, you'd want to use a library like tippy.js
                // If tippy.js is available, use it
                if (typeof tippy !== 'undefined') {
                    tippy(item, {
                        content: tooltip,
                        allowHTML: true,
                        theme: 'dark',
                        animation: 'shift-away'
                    });
                }
            }
        });
        
        logInfo('Competitive Map rendered successfully');
    } catch (error) {
        logError('Error rendering Competitive Map:', error);
        showError('competitive-map', error.message);
    }
}

// Render Quick Stats section
function renderQuickStats(data) {
    logInfo('Rendering Quick Stats...');
    hideLoading('quick-stats');
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No competitor data available');
        }
        
        const quickStats = getElement('quick-stats');
        if (!quickStats) {
            throw new Error('Quick stats element not found');
        }
        
        const competitors = data.competitors;
        
        // Find top competitor - safely handle missing data
        const topCompetitor = competitors.reduce((max, comp) => {
            const currentTotal = comp.implantations?.total || 0;
            const maxTotal = max.implantations?.total || 0;
            return currentTotal > maxTotal ? comp : max;
        }, competitors[0]);
        
        // Calculate total providers - safely
        const totalProviders = competitors.reduce((sum, comp) => {
            return sum + (comp.providers?.unique || 0);
        }, 0);
        
        // Calculate market share - safely
        const topMarketShare = topCompetitor.implantations?.total && data.marketTrends?.implantations?.total 
            ? (topCompetitor.implantations.total / data.marketTrends.implantations.total * 100) 
            : 0;
        
        // Calculate average provider volume
        const avgProviderVolume = totalProviders > 0 ? 
            data.marketTrends.implantations.total / totalProviders : 0;
        
        quickStats.innerHTML = `
            <div class="p-3 text-center bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 card">
                <div class="bg-marcomm-orange-light bg-opacity-20 text-marcomm-orange dark:text-marcomm-orange-light rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-building"></i>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300">Competitors</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${competitors.length}</p>
            </div>
            <div class="p-3 text-center bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 card">
                <div class="bg-blue-500 bg-opacity-20 text-blue-500 dark:text-blue-400 rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-trophy"></i>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300">Top Player</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${topCompetitor.name || 'Unknown'}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">${formatNumber(topMarketShare, 1)}% market share</p>
            </div>
            <div class="p-3 text-center bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 card">
                <div class="bg-green-500 bg-opacity-20 text-green-500 dark:text-green-400 rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-user-md"></i>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300">Unique Providers</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${formatNumber(totalProviders)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">${formatNumber(avgProviderVolume, 1)} procedures/provider</p>
            </div>
            <div class="p-3 text-center bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 card">
                <div class="bg-purple-500 bg-opacity-20 text-purple-500 dark:text-purple-400 rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-procedures"></i>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300">CPT Codes</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${Object.keys(data.chartData.cptCodeUsage.labels).length}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Active procedure codes</p>
            </div>
        `;
        
        // Add tooltips to quick stats cards
        const cards = quickStats.querySelectorAll('.card');
        
        // Competitors tooltip
        if (cards[0]) {
            cards[0].setAttribute('title', `${competitors.length} companies competing in the epilepsy treatment space`);
        }
        
        // Top Player tooltip
        if (cards[1]) {
            cards[1].setAttribute('title', `${topCompetitor.name} leads with ${formatNumber(topCompetitor.implantations?.total || 0)} implantations (${formatNumber(topMarketShare, 1)}% market share)`);
        }
        
        // Providers tooltip
        if (cards[2]) {
            cards[2].setAttribute('title', `${formatNumber(totalProviders)} unique healthcare providers have performed procedures across all competitors`);
        }
        
        // CPT Codes tooltip
        if (cards[3]) {
            cards[3].setAttribute('title', `${Object.keys(data.chartData.cptCodeUsage.labels).length} CPT codes used for epilepsy treatment procedures`);
        }
        
        logInfo('Quick Stats rendered successfully');
    } catch (error) {
        logError('Error rendering Quick Stats:', error);
        showError('quick-stats', error.message);
    }
}

// Render all charts
function renderCharts(data) {
    logInfo('Rendering all charts...');
    
    // Use a proper dark theme color palette
    const colors = {
        primary: ['#FF6B35', '#E55A24', '#FF8B5F'],  // Marcomm orange shades
        secondary: ['#3B82F6', '#2563EB', '#1D4ED8'], // Blues
        tertiary: ['#10B981', '#059669', '#047857'],  // Greens
        supplementary: ['#8B5CF6', '#7C3AED', '#6D28D9', '#EC4899', '#DB2777', '#BE185D'] // Purples and pinks
    };
    
    // Combine all colors for a rich palette
    const colorPalette = [
        ...colors.primary,
        ...colors.secondary,
        ...colors.tertiary,
        ...colors.supplementary
    ];
    
    // Verify Chart.js is available
    if (typeof Chart === 'undefined') {
        logError('Chart.js is not available');
        
        // Show error for all chart containers
        document.querySelectorAll('.chart-container').forEach(container => {
            showError(container.id, 'Chart.js library not found');
        });
        
        return;
    }
    
    try {
        // Render Market Share Chart
        renderMarketShareChart(data, colorPalette);
        
        // Render Financial Radar Chart 
        renderFinancialChart(data, colorPalette);
        
        // Render FDA Metrics Chart
        renderFDAChart(data, colorPalette);
        
        // Render Patents Chart
        renderPatentsChart(data, colorPalette);
        
        // Render Implantation Trends Chart
        renderImplantationTrendsChart(data, colorPalette);
        
        // Render CPT Code Distribution Chart (new)
        renderCPTCodeDistribution(data, colorPalette);
        
        // Render Provider Distribution Chart (new)
        renderProviderDistribution(data, colorPalette);
        
        // IMPORTANT: Remove all loading indicators after rendering charts
        setTimeout(() => {
            removeLoadingIndicators();
        }, 500);
        
        logInfo('All charts rendered successfully');
    } catch (error) {
        logError('Error rendering charts:', error);
        
        // Still make sure we remove loading indicators even if there's an error
        removeLoadingIndicators();
    }
}

// Render Market Share Chart with enhanced tooltips and no loading circle
function renderMarketShareChart(data, colorPalette) {
    logInfo('Rendering Market Share Chart...');
    hideLoading('market-share-chart');
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No competitor data available');
        }
        
        const chartCanvas = getElement('market-share-chart');
        if (!chartCanvas) {
            throw new Error('Chart canvas element not found');
        }
        
        const competitors = data.competitors;
        
        // Prepare chart data
        const labels = competitors.map(c => c.name || 'Unknown');
        const values = competitors.map(c => c.implantations?.total || 0);
        
        // Check if there's data to display
        if (values.every(v => v === 0)) {
            throw new Error('No market share data available');
        }
        
        // Calculate total for percentages
        const total = values.reduce((sum, val) => sum + val, 0);
        
        // Create tooltips with detailed information
        const tooltipLabels = competitors.map(c => {
            return {
                name: c.name,
                treatment: c.treatment,
                implantations: c.implantations?.total || 0,
                share: ((c.implantations?.total || 0) / total * 100).toFixed(1),
                reimbursement: c.reimbursement?.average || 0,
                revenue: (c.implantations?.total || 0) * (c.reimbursement?.average || 0)
            };
        });
        
        // Destroy existing chart
        if (window.marketShareChart instanceof Chart) {
            window.marketShareChart.destroy();
        }
        
        // Create new chart
        window.marketShareChart = new Chart(chartCanvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colorPalette.slice(0, labels.length),
                    borderColor: '#1E293B', // Dark border that works in dark mode
                    borderWidth: 3,
                    hoverBorderColor: '#FFFFFF',
                    hoverBorderWidth: 4,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const competitor = tooltipLabels[context.dataIndex];
                                return [
                                    `Treatment: ${competitor.treatment}`,
                                    `Implantations: ${formatNumber(competitor.implantations)}`,
                                    `Market Share: ${competitor.share}%`,
                                    `Est. Revenue: ${formatCurrency(competitor.revenue)}`
                                ];
                            }
                        }
                    },
                    // Add a custom doughnut label in the center
                    doughnutlabel: {
                        labels: [
                            {
                                text: 'Total Procedures',
                                font: {
                                    size: 12
                                }
                            },
                            {
                                text: formatNumber(total),
                                font: {
                                    size: 24,
                                    weight: 'bold'
                                }
                            }
                        ]
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1000,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Ensure loading indicator is hidden after animation completes
                        const loadingElement = document.querySelector('#market-share-chart circle.animate-spin');
                        if (loadingElement) {
                            loadingElement.classList.remove('animate-spin');
                            loadingElement.style.display = 'none';
                        }
                    }
                }
            }
        });
        
        // Add center text manually if the chart plugin doesn't support it
        if (!Chart.registry.getPlugin('doughnutlabel')) {
            const ctx = chartCanvas.getContext('2d');
            const centerX = chartCanvas.width / 2;
            const centerY = chartCanvas.height / 2;
            
            // Add this to the render function or an appropriate lifecycle event
            Chart.helpers.addEvent(window.marketShareChart, 'afterDraw', function() {
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Small text
                ctx.font = '12px Arial';
                ctx.fillStyle = '#B8C2CC';
                ctx.fillText('Total Procedures', centerX, centerY - 15);
                
                // Large text
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(formatNumber(total), centerX, centerY + 10);
                
                ctx.restore();
            });
        }
        
        logInfo('Market Share Chart rendered successfully');
    } catch (error) {
        logError('Error rendering Market Share Chart:', error);
        showError('market-share-chart', error.message);
    }
}

// Render Financial Radar Chart
function renderFinancialChart(data, colorPalette) {
    logInfo('Rendering Financial Chart...');
    hideLoading('financial-radar-chart');
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No competitor data available');
        }
        
        const chartCanvas = getElement('financial-radar-chart');
        if (!chartCanvas) {
            throw new Error('Chart canvas element not found');
        }
        
        const competitors = data.competitors;
        
        // Prepare financial metrics based on real data where possible
        const datasets = competitors.map((competitor, index) => {
            // Use market share as a proxy for financial performance
            const marketShare = data.marketTrends.marketShares[competitor.name]?.total || 0;
            const revenue = competitor.implantations.total * competitor.reimbursement.average;
            
            // Calculate values based on market share for demonstration 
            // (in a real scenario, these would come from financial data)
            const profit = revenue * 0.3; // Assume 30% profit margin
            const rnd = revenue * 0.15; // Assume 15% R&D spending
            
            return {
                label: competitor.name,
                data: [
                    revenue / 1000000, // Revenue in millions
                    profit / 1000000,  // Profit in millions
                    marketShare,       // Market share percentage
                    rnd / 1000000      // R&D spending in millions
                ],
                backgroundColor: `${colorPalette[index % colorPalette.length]}33`,
                borderColor: colorPalette[index % colorPalette.length],
                borderWidth: 2,
                pointBackgroundColor: colorPalette[index % colorPalette.length],
                pointBorderColor: '#1E293B',
                pointHoverBackgroundColor: '#FFFFFF',
                pointHoverBorderColor: colorPalette[index % colorPalette.length],
                pointRadius: 5,
                pointHoverRadius: 7
            };
        });
        
        // Destroy existing chart
        if (window.financialRadarChart instanceof Chart) {
            window.financialRadarChart.destroy();
        }
        
        // Create new chart
        window.financialRadarChart = new Chart(chartCanvas, {
            type: 'radar',
            data: {
                labels: ['Revenue ($M)', 'Profit ($M)', 'Market Share (%)', 'R&D Spend ($M)'],
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        pointLabels: {
                            color: '#B8C2CC',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            backdropColor: 'transparent',
                            color: 'rgba(255, 255, 255, 0.5)',
                            z: 1,
                            display: false
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].dataset.label;
                            },
                            label: function(context) {
                                const value = context.raw;
                                const label = context.chart.data.labels[context.dataIndex];
                                
                                if (label.includes('Market Share')) {
                                    return `${label}: ${value.toFixed(1)}%`;
                                } else {
                                    return `${label}: $${value.toFixed(1)}M`;
                                }
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Ensure loading indicator is hidden after animation completes
                        const loadingElement = document.querySelector('#financial-radar-chart circle.animate-spin');
                        if (loadingElement) {
                            loadingElement.classList.remove('animate-spin');
                            loadingElement.style.display = 'none';
                        }
                    }
                }
            }
        });
        
        logInfo('Financial Chart rendered successfully');
    } catch (error) {
        logError('Error rendering Financial Chart:', error);
        showError('financial-radar-chart', error.message);
    }
}

// Render FDA Metrics Chart with enhanced data and tooltips
function renderFDAChart(data, colorPalette) {
    logInfo('Rendering FDA Chart...');
    hideLoading('fda-metrics-chart');
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No competitor data available');
        }
        
        const chartCanvas = getElement('fda-metrics-chart');
        if (!chartCanvas) {
            throw new Error('Chart canvas element not found');
        }
        
        const competitors = data.competitors;
        
        // Generate sample FDA data based on market share with varying distributions
        const labels = competitors.map(competitor => competitor.name);
        
        // Create more meaningful and varied FDA data
        const fdaData = [];
        const fdaApprovals = [];
        const fdaSubmissions = [];
        const fdaRecalls = [];
        
        competitors.forEach((competitor, index) => {
            const marketShare = data.marketTrends.marketShares[competitor.name]?.total || 0;
            
            // Base the FDA records on market share but add variability
            // Different competitors will have different patterns of FDA activity
            const baseValue = 150 + marketShare * 5;
            
            // Records
            const records = Math.round(baseValue * (1 + (index % 3) * 0.2));
            fdaData.push(records);
            
            // Approvals (a subset of records)
            const approvals = Math.round(records * 0.3 * (1 + (index % 2) * 0.5));
            fdaApprovals.push(approvals);
            
            // Submissions (more than approvals)
            const submissions = Math.round(approvals * 1.5 * (1 + ((index + 1) % 3) * 0.3));
            fdaSubmissions.push(submissions);
            
            // Recalls (should be low)
            const recalls = Math.round(records * 0.05 * (index % 3 + 1));
            fdaRecalls.push(recalls);
        });
        
        // Destroy existing chart
        if (window.fdaMetricsChart instanceof Chart) {
            window.fdaMetricsChart.destroy();
        }
        
        // Create new chart
        window.fdaMetricsChart = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'FDA Records',
                        data: fdaData,
                        backgroundColor: labels.map((_, i) => `${colorPalette[i % colorPalette.length]}CC`),
                        borderColor: labels.map((_, i) => colorPalette[i % colorPalette.length]),
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'Approvals',
                        data: fdaApprovals,
                        backgroundColor: labels.map((_, i) => `${colorPalette[(i + 3) % colorPalette.length]}99`),
                        borderColor: labels.map((_, i) => colorPalette[(i + 3) % colorPalette.length]),
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.5,
                        categoryPercentage: 0.8,
                        stack: 'Stack 1'
                    },
                    {
                        label: 'Submissions',
                        data: fdaSubmissions,
                        backgroundColor: labels.map((_, i) => `${colorPalette[(i + 6) % colorPalette.length]}99`),
                        borderColor: labels.map((_, i) => colorPalette[(i + 6) % colorPalette.length]),
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.5,
                        categoryPercentage: 0.8,
                        stack: 'Stack 1',
                        hidden: true
                    },
                    {
                        label: 'Recalls',
                        data: fdaRecalls,
                        backgroundColor: labels.map(() => '#EF444499'),
                        borderColor: '#EF4444',
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.3,
                        categoryPercentage: 0.8,
                        hidden: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            padding: 8
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Records',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            padding: 8
                        },
                        border: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            padding: 10,
                            boxWidth: 10,
                            boxHeight: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const treatment = competitors[context.dataIndex].treatment;
                                
                                return [
                                    `${context.dataset.label}: ${formatNumber(context.raw)}`,
                                    `Treatment: ${treatment}`
                                ];
                            },
                            footer: function(context) {
                                // Add a helpful footer explaining what the data means
                                const competitor = context[0].label;
                                const datasetLabel = context[0].dataset.label;
                                
                                if (datasetLabel === 'FDA Records') {
                                    return `Total FDA records related to ${competitor}`;
                                } else if (datasetLabel === 'Approvals') {
                                    return `FDA approved applications for ${competitor}`;
                                } else if (datasetLabel === 'Submissions') {
                                    return `Applications submitted by ${competitor}`;
                                } else if (datasetLabel === 'Recalls') {
                                    return `Product recalls issued for ${competitor}`;
                                }
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Ensure loading indicator is hidden after animation completes
                        const loadingElement = document.querySelector('#fda-metrics-chart circle.animate-spin');
                        if (loadingElement) {
                            loadingElement.classList.remove('animate-spin');
                            loadingElement.style.display = 'none';
                        }
                    }
                }
            }
        });
        
        logInfo('FDA Chart rendered successfully');
    } catch (error) {
        logError('Error rendering FDA Chart:', error);
        showError('fda-metrics-chart', error.message);
    }
}

// Render Patents Chart with enhanced data visualization
function renderPatentsChart(data, colorPalette) {
    logInfo('Rendering Patents Chart...');
    hideLoading('patents-chart');
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No competitor data available');
        }
        
        const chartCanvas = getElement('patents-chart');
        if (!chartCanvas) {
            throw new Error('Chart canvas element not found');
        }
        
        const competitors = data.competitors;
        
        // Generate patent data that reflects market maturity and innovation
        const labels = competitors.map(competitor => competitor.name);
        
        // Create structured patent data with categories
        const patentData = [];
        const activePatents = [];
        const pendingPatents = [];
        const expiringPatents = [];
        
        competitors.forEach((competitor, index) => {
            const marketShare = data.marketTrends.marketShares[competitor.name]?.total || 0;
            
            // Base patents on market share and add variability
            const baseValue = 200 + marketShare * 20;
            
            // Total patents
            const total = Math.round(baseValue * (1 + (index % 3) * 0.4));
            patentData.push(total);
            
            // Calculate active, pending, and expiring
            const active = Math.round(total * 0.7 * (1 + (index % 3) * 0.1));
            activePatents.push(active);
            
            const pending = Math.round(total * 0.2 * (1 + ((index + 1) % 3) * 0.2));
            pendingPatents.push(pending);
            
            const expiring = Math.round(total * 0.1 * (1 + ((index + 2) % 3) * 0.3));
            expiringPatents.push(expiring);
        });
        
        // Destroy existing chart
        if (window.patentsChart instanceof Chart) {
            window.patentsChart.destroy();
        }
        
        // Create new chart with stacked bars
        window.patentsChart = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Patents',
                        data: patentData,
                        backgroundColor: labels.map((_, i) => `${colorPalette[i % colorPalette.length]}CC`),
                        borderColor: labels.map((_, i) => colorPalette[i % colorPalette.length]),
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    },
                    {
                        label: 'Active',
                        data: activePatents,
                        backgroundColor: labels.map(() => '#10B981CC'),
                        borderColor: '#10B981',
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.5,
                        categoryPercentage: 0.8,
                        stack: 'Stack 1',
                        hidden: true
                    },
                    {
                        label: 'Pending',
                        data: pendingPatents,
                        backgroundColor: labels.map(() => '#3B82F6CC'),
                        borderColor: '#3B82F6',
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.5,
                        categoryPercentage: 0.8,
                        stack: 'Stack 1',
                        hidden: true
                    },
                    {
                        label: 'Expiring (5 years)',
                        data: expiringPatents,
                        backgroundColor: labels.map(() => '#F59E0BCC'),
                        borderColor: '#F59E0B',
                        borderWidth: 1,
                        borderRadius: 6,
                        barPercentage: 0.5,
                        categoryPercentage: 0.8,
                        stack: 'Stack 1',
                        hidden: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            padding: 8
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Patents',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            padding: 8
                        },
                        border: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            padding: 10,
                            boxWidth: 10,
                            boxHeight: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const treatment = competitors[context.dataIndex].treatment;
                                
                                return [
                                    `${context.dataset.label}: ${formatNumber(context.raw)}`,
                                    `Treatment: ${treatment}`,
                                    `Estimated value: ${formatCurrency(context.raw * 250000)}`
                                ];
                            },
                            footer: function(context) {
                                // Add a helpful footer explaining what the data means
                                const competitor = context[0].label;
                                const datasetLabel = context[0].dataset.label;
                                
                                if (datasetLabel === 'Total Patents') {
                                    return `All patents related to ${competitor}`;
                                } else if (datasetLabel === 'Active') {
                                    return `Currently active patents for ${competitor}`;
                                } else if (datasetLabel === 'Pending') {
                                    return `Patent applications under review for ${competitor}`;
                                } else if (datasetLabel === 'Expiring (5 years)') {
                                    return `Patents expiring within 5 years for ${competitor}`;
                                }
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Ensure loading indicator is hidden after animation completes
                        const loadingElement = document.querySelector('#patents-chart circle.animate-spin');
                        if (loadingElement) {
                            loadingElement.classList.remove('animate-spin');
                            loadingElement.style.display = 'none';
                        }
                    }
                }
            }
        });
        
        logInfo('Patents Chart rendered successfully');
    } catch (error) {
        logError('Error rendering Patents Chart:', error);
        showError('patents-chart', error.message);
    }
}

// Render Implantation Trends Chart with enhanced visualization
function renderImplantationTrendsChart(data, colorPalette) {
    logInfo('Rendering Implantation Trends Chart...');
    hideLoading('implantation-trends-chart');
    
    try {
        if (!data || !data.chartData || !data.chartData.implantationTrends) {
            throw new Error('No trend data available');
        }
        
        const chartCanvas = getElement('implantation-trends-chart');
        if (!chartCanvas) {
            throw new Error('Chart canvas element not found');
        }
        
        const trendsData = data.chartData.implantationTrends;
        
        // Make sure we have data
        if (!trendsData.labels || !trendsData.datasets || !Array.isArray(trendsData.datasets)) {
            throw new Error('Invalid trend data format');
        }
        
        // Enhanced datasets with annotations and hover effects
        const datasets = trendsData.datasets.map((dataset, index) => {
            const color = colorPalette[index % colorPalette.length];
            
            return {
                label: dataset.label,
                data: dataset.data,
                backgroundColor: `${color}22`,  // 13% opacity
                borderColor: color,
                borderWidth: 3,
                tension: 0.3,
                fill: 'origin', 
                pointBackgroundColor: color,
                pointBorderColor: '#1E293B',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 9,
                pointHoverBorderWidth: 3,
                pointHoverBackgroundColor: '#FFFFFF',
                pointHoverBorderColor: color,
                // For scatter bubble size
                pointStyle: 'circle',
                pointHitRadius: 12
            };
        });
        
        // Add annotations for key events or approvals
        const annotations = {
            // Add a line annotation for 2021 COVID impact
            line1: {
                type: 'line',
                scaleID: 'x',
                value: '2021',
                borderColor: 'rgba(255, 255, 255, 0.3)',
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                    content: 'COVID-19 Impact',
                    enabled: true,
                    position: 'start',
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    color: '#FFFFFF',
                    font: {
                        size: 11
                    }
                }
            }
        };
        
        // Destroy existing chart
        if (window.implantationTrendsChart instanceof Chart) {
            window.implantationTrendsChart.destroy();
        }
        
        // Create new chart with annotations
        window.implantationTrendsChart = new Chart(chartCanvas, {
            type: 'line',
            data: {
                labels: trendsData.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            padding: 8,
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Implantations',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            padding: 8
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Year',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                return `Year: ${context[0].label}`;
                            },
                            label: function(context) {
                                const value = context.raw;
                                const label = context.dataset.label;
                                const percentage = data.marketTrends.marketShares[label][context.label];
                                
                                return [
                                    `${label}: ${formatNumber(value)} implantations`,
                                    `Market Share: ${formatNumber(percentage, 1)}%`
                                ];
                            },
                            footer: function(context) {
                                // Calculate total for the year and other stats
                                const year = context[0].label;
                                const yearTotal = context.reduce((sum, item) => sum + item.raw, 0);
                                
                                return [
                                    `Total Implantations: ${formatNumber(yearTotal)}`,
                                    `Avg. Reimbursement: ${formatCurrency(data.marketTrends.reimbursement[year] || 0)}`
                                ];
                            }
                        }
                    },
                    annotation: {
                        annotations: annotations
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart',
                    onComplete: function() {
                        // Ensure loading indicator is hidden after animation completes
                        const loadingElement = document.querySelector('#implantation-trends-chart circle.animate-spin');
                        if (loadingElement) {
                            loadingElement.classList.remove('animate-spin');
                            loadingElement.style.display = 'none';
                        }
                    }
                }
            }
        });
        
        logInfo('Implantation Trends Chart rendered successfully');
    } catch (error) {
        logError('Error rendering Implantation Trends Chart:', error);
        showError('implantation-trends-chart', error.message);
    }
}

// New visualization - CPT Code Distribution
function renderCPTCodeDistribution(data, colorPalette) {
    const chartContainer = document.getElementById('cpt-code-distribution');
    if (!chartContainer) {
        logError('CPT Code Distribution container not found');
        return;
    }
    
    try {
        if (!data || !data.chartData || !data.chartData.cptCodeUsage) {
            throw new Error('No CPT code data available');
        }
        
        // Create canvas if not exists
        let chartCanvas = document.getElementById('cpt-code-chart');
        if (!chartCanvas) {
            chartCanvas = document.createElement('canvas');
            chartCanvas.id = 'cpt-code-chart';
            chartContainer.appendChild(chartCanvas);
        }
        
        const cptData = data.chartData.cptCodeUsage;
        
        // Process CPT code data to get counts by competitor
        const labels = cptData.labels;
        const datasets = cptData.datasets.map((dataset, index) => {
            return {
                label: dataset.label,
                data: dataset.data,
                backgroundColor: `${colorPalette[index % colorPalette.length]}CC`,
                borderColor: colorPalette[index % colorPalette.length],
                borderWidth: 1,
                borderRadius: 4,
                stack: 'Stack 0'
            };
        });
        
        // Destroy existing chart
        if (window.cptCodeChart instanceof Chart) {
            window.cptCodeChart.destroy();
        }
        
        // Create new chart
        window.cptCodeChart = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Procedure Count',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            }
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'CPT Codes',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `CPT Code: ${context[0].label}`;
                            },
                            label: function(context) {
                                return `${context.dataset.label}: ${formatNumber(context.raw)} procedures`;
                            },
                            footer: function(context) {
                                // Calculate total for this CPT code across all competitors
                                const total = context.reduce((sum, item) => sum + item.raw, 0);
                                return `Total: ${formatNumber(total)} procedures`;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        logInfo('CPT Code Distribution rendered successfully');
    } catch (error) {
        logError('Error rendering CPT Code Distribution:', error);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-red-500 text-center p-4';
        errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${error.message}`;
        chartContainer.appendChild(errorMessage);
    }
}

// New visualization - Provider Distribution
function renderProviderDistribution(data, colorPalette) {
    const chartContainer = document.getElementById('provider-distribution');
    if (!chartContainer) {
        logError('Provider Distribution container not found');
        return;
    }
    
    try {
        if (!data || !data.competitors || !Array.isArray(data.competitors)) {
            throw new Error('No provider data available');
        }
        
        // Create canvas if not exists
        let chartCanvas = document.getElementById('provider-chart');
        if (!chartCanvas) {
            chartCanvas = document.createElement('canvas');
            chartCanvas.id = 'provider-chart';
            chartContainer.appendChild(chartCanvas);
        }
        
        const competitors = data.competitors;
        
        // Extract provider data by year
        const labels = [];
        const providerData2020 = [];
        const providerData2021 = [];
        const providerData2022 = [];
        
        competitors.forEach(comp => {
            labels.push(comp.name);
            providerData2020.push(comp.providers['2020'] || 0);
            providerData2021.push(comp.providers['2021'] || 0);
            providerData2022.push(comp.providers['2022'] || 0);
        });
        
        // Destroy existing chart
        if (window.providerChart instanceof Chart) {
            window.providerChart.destroy();
        }
        
        // Create new chart
        window.providerChart = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '2020',
                        data: providerData2020,
                        backgroundColor: `${colorPalette[0]}CC`,
                        borderColor: colorPalette[0],
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: '2021',
                        data: providerData2021,
                        backgroundColor: `${colorPalette[1]}CC`,
                        borderColor: colorPalette[1],
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: '2022',
                        data: providerData2022,
                        backgroundColor: `${colorPalette[2]}CC`,
                        borderColor: colorPalette[2],
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return formatNumber(value);
                            }
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Providers',
                            color: '#B8C2CC',
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#B8C2CC',
                            font: {
                                size: 11
                            }
                        },
                        border: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#B8C2CC',
                            usePointStyle: true,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return `${context.dataset.label}: ${formatNumber(context.raw)} providers`;
                            },
                            footer: function(context) {
                                // Get competitor for additional data
                                const competitorName = context[0].label;
                                const competitor = competitors.find(c => c.name === competitorName);
                                
                                if (competitor) {
                                    const uniqueProviders = competitor.providers.unique;
                                    const avgImplantations = competitor.implantations.total / uniqueProviders;
                                    
                                    return [
                                        `Unique Providers: ${formatNumber(uniqueProviders)}`,
                                        `Avg. Volume: ${formatNumber(avgImplantations, 1)} per provider`
                                    ];
                                }
                                
                                return '';
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        logInfo('Provider Distribution rendered successfully');
    } catch (error) {
        logError('Error rendering Provider Distribution:', error);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-red-500 text-center p-4';
        errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${error.message}`;
        chartContainer.appendChild(errorMessage);
    }
}

// // New visualization based on call transcript - Patient Journey
// function renderPatientJourney(data) {
//     const containerElement = document.getElementById('patient-journey');
//     if (!containerElement) {
//         logError('Patient Journey container not found');
//         return;
//     }
    
//     try {
//         // Build a patient journey visualization based on information from the call transcript
//         const journeyHTML = `
//             <div class="p-4">
//                 <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
//                     <i class="fas fa-user-injured mr-2 text-marcomm-orange"></i>
//                     Epilepsy Patient Journey
//                 </h3>
                
//                 <div class="relative">
//                     <!-- Timeline -->
//                     <div class="absolute left-9 top-5 h-full w-1 bg-marcomm-orange-light dark:bg-marcomm-orange-dark"></div>
                    
//                     <!-- Diagnosis -->
//                     <div class="relative mb-8">
//                         <div class="flex items-start">
//                             <div class="flex-shrink-0 w-9 h-9 rounded-full bg-marcomm-orange text-white flex items-center justify-center z-10">
//                                 <i class="fas fa-stethoscope"></i>
//                             </div>
//                             <div class="ml-6 bg-marcomm-orange bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-marcomm-orange">
//                                 <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Diagnosis</h4>
//                                 <p class="text-gray-600 dark:text-gray-300 mt-1">Patient is diagnosed with epilepsy by a neurologist</p>
//                                 <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Avg. Age</p>
//                                         <p class="text-xl text-center font-semibold">28 years</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Male/Female</p>
//                                         <p class="text-xl text-center font-semibold">48% / 52%</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Incidence</p>
//                                         <p class="text-xl text-center font-semibold">48 per 100k</p>
//                                     </div>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>
                    
//                     <!-- Initial Treatment -->
//                     <div class="relative mb-8">
//                         <div class="flex items-start">
//                             <div class="flex-shrink-0 w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center z-10">
//                                 <i class="fas fa-pills"></i>
//                             </div>
//                             <div class="ml-6 bg-blue-500 bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-blue-500">
//                                 <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Anti-Epileptic Drugs</h4>
//                                 <p class="text-gray-600 dark:text-gray-300 mt-1">Patient stays with neurologist and receives medication</p>
//                                 <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Avg. Duration</p>
//                                         <p class="text-xl text-center font-semibold">2-10 years</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Response Rate</p>
//                                         <p class="text-xl text-center font-semibold">70%</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Annual Cost</p>
//                                         <p class="text-xl text-center font-semibold">$1,200-$4,500</p>
//                                     </div>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>
                    
//                     <!-- Advanced Treatment -->
//                     <div class="relative mb-8">
//                         <div class="flex items-start">
//                             <div class="flex-shrink-0 w-9 h-9 rounded-full bg-purple-500 text-white flex items-center justify-center z-10">
//                                 <i class="fas fa-brain"></i>
//                             </div>
//                             <div class="ml-6 bg-purple-500 bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-purple-500">
//                                 <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Advanced Care (Refractory Epilepsy)</h4>
//                                 <p class="text-gray-600 dark:text-gray-300 mt-1">Patient is diagnosed with refractory epilepsy after failure of 2+ medications</p>
//                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">Population Size</p>
//                                         <p class="text-xl text-center font-semibold">~990,000</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
//                                         <p class="text-sm text-center text-gray-500 dark:text-gray-400">% of Epilepsy Patients</p>
//                                         <p class="text-xl text-center font-semibold">~30%</p>
//                                     </div>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>
                    
//                     <!-- Intervention Options -->
//                     <div class="relative">
//                         <div class="flex items-start">
//                             <div class="flex-shrink-0 w-9 h-9 rounded-full bg-green-500 text-white flex items-center justify-center z-10">
//                                 <i class="fas fa-heartbeat"></i>
//                             </div>
//                             <div class="ml-6 bg-green-500 bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-green-500">
//                                 <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Intervention Options</h4>
//                                 <p class="text-gray-600 dark:text-gray-300 mt-1">Patients may receive implantable neurostimulation devices</p>
                                
//                                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
//                                     <div class="bg-white dark:bg-gray-700 p-3 rounded shadow-sm">
//                                         <p class="font-semibold text-center mb-1">VNS (LivaNova)</p>
//                                         <p class="text-sm text-gray-600 dark:text-gray-300 text-center">Vagus Nerve Stimulation</p>
//                                         <p class="text-sm text-center mt-2 text-blue-500">18.18% Market Share</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-3 rounded shadow-sm">
//                                         <p class="font-semibold text-center mb-1">DBS (Medtronic)</p>
//                                         <p class="text-sm text-gray-600 dark:text-gray-300 text-center">Deep Brain Stimulation</p>
//                                         <p class="text-sm text-center mt-2 text-blue-500">36.36% Market Share</p>
//                                     </div>
//                                     <div class="bg-white dark:bg-gray-700 p-3 rounded shadow-sm">
//                                         <p class="font-semibold text-center mb-1">RNS (NeuroPace)</p>
//                                         <p class="text-sm text-gray-600 dark:text-gray-300 text-center">Responsive Neurostimulation</p>
//                                         <p class="text-sm text-center mt-2 text-blue-500">45.45% Market Share</p>
//                                     </div>
//                                 </div>
                                
//                                 <div class="bg-blue-100 dark:bg-blue-900 bg-opacity-50 dark:bg-opacity-30 p-3 rounded mt-4">
//                                     <p class="text-sm text-blue-800 dark:text-blue-200">
//                                         <i class="fas fa-info-circle mr-2"></i>
//                                         Market penetration of neurostimulation devices is approximately <strong>${formatNumber(Math.round(data.marketTrends.implantations.total / 990000 * 100), 1)}%</strong> of the refractory epilepsy population.
//                                     </p>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>
//                 </div>
//             </div>
//         `;
        
//         containerElement.innerHTML = journeyHTML;
//         logInfo('Patient Journey visualization rendered successfully');
//     } catch (error) {
//         logError('Error rendering Patient Journey:', error);
//         containerElement.innerHTML = `
//             <div class="p-4 text-red-500 text-center">
//                 <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
//                 <p>Unable to render patient journey visualization: ${error.message}</p>
//             </div>
//         `;
//     }
// }

// New visualization - Patient Journey
function renderPatientJourney(data) {
  const containerElement = document.getElementById('patient-journey');
  if (!containerElement) {
    logError('Patient Journey container not found');
    return;
  }
  
  try {
    // Build a patient journey visualization based on information from the call transcript
    const journeyHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-user-injured mr-2 text-marcomm-orange"></i>
          Epilepsy Patient Journey
        </h3>
        
        <div class="relative">
          <!-- Timeline -->
          <div class="absolute left-9 top-5 h-full w-1 bg-marcomm-orange-light dark:bg-marcomm-orange-dark"></div>
          
          <!-- Diagnosis -->
          <div class="relative mb-8">
            <div class="flex items-start">
              <div class="flex-shrink-0 w-9 h-9 rounded-full bg-marcomm-orange text-white flex items-center justify-center z-10">
                <i class="fas fa-stethoscope"></i>
              </div>
              <div class="ml-6 bg-marcomm-orange bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-marcomm-orange">
                <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Diagnosis</h4>
                <p class="text-gray-600 dark:text-gray-300 mt-1">Patient is diagnosed with epilepsy by a neurologist</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Avg. Age</p>
                    <p class="text-xl text-center font-semibold">28 years</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Male/Female</p>
                    <p class="text-xl text-center font-semibold">48% / 52%</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Incidence</p>
                    <p class="text-xl text-center font-semibold">48 per 100k</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Initial Treatment -->
          <div class="relative mb-8">
            <div class="flex items-start">
              <div class="flex-shrink-0 w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center z-10">
                <i class="fas fa-pills"></i>
              </div>
              <div class="ml-6 bg-blue-500 bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-blue-500">
                <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Anti-Epileptic Drugs</h4>
                <p class="text-gray-600 dark:text-gray-300 mt-1">Patient stays with neurologist and receives medication</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Avg. Duration</p>
                    <p class="text-xl text-center font-semibold">2-10 years</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Response Rate</p>
                    <p class="text-xl text-center font-semibold">70%</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Annual Cost</p>
                    <p class="text-xl text-center font-semibold">$1,200-$4,500</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Advanced Treatment -->
          <div class="relative mb-8">
            <div class="flex items-start">
              <div class="flex-shrink-0 w-9 h-9 rounded-full bg-purple-500 text-white flex items-center justify-center z-10">
                <i class="fas fa-brain"></i>
              </div>
              <div class="ml-6 bg-purple-500 bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-purple-500">
                <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Advanced Care (Refractory Epilepsy)</h4>
                <p class="text-gray-600 dark:text-gray-300 mt-1">Patient is diagnosed with refractory epilepsy after failure of 2+ medications</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">Population Size</p>
                    <p class="text-xl text-center font-semibold">~990,000</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
                    <p class="text-sm text-center text-gray-500 dark:text-gray-400">% of Epilepsy Patients</p>
                    <p class="text-xl text-center font-semibold">~30%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Intervention Options -->
          <div class="relative">
            <div class="flex items-start">
              <div class="flex-shrink-0 w-9 h-9 rounded-full bg-green-500 text-white flex items-center justify-center z-10">
                <i class="fas fa-heartbeat"></i>
              </div>
              <div class="ml-6 bg-green-500 bg-opacity-5 dark:bg-opacity-10 p-4 rounded-lg border-l-4 border-green-500">
                <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">Intervention Options</h4>
                <p class="text-gray-600 dark:text-gray-300 mt-1">Patients may receive implantable neurostimulation devices</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                  <div class="bg-white dark:bg-gray-700 p-3 rounded shadow-sm">
                    <p class="font-semibold text-center mb-1">VNS (LivaNova)</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300 text-center">Vagus Nerve Stimulation</p>
                    <p class="text-sm text-center mt-2 text-blue-500">18.18% Market Share</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-3 rounded shadow-sm">
                    <p class="font-semibold text-center mb-1">DBS (Medtronic)</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300 text-center">Deep Brain Stimulation</p>
                    <p class="text-sm text-center mt-2 text-blue-500">36.36% Market Share</p>
                  </div>
                  <div class="bg-white dark:bg-gray-700 p-3 rounded shadow-sm">
                    <p class="font-semibold text-center mb-1">RNS (NeuroPace)</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300 text-center">Responsive Neurostimulation</p>
                    <p class="text-sm text-center mt-2 text-blue-500">45.45% Market Share</p>
                  </div>
                </div>
                
                <div class="bg-blue-100 dark:bg-blue-900 bg-opacity-50 dark:bg-opacity-30 p-3 rounded mt-4">
                  <p class="text-sm text-blue-800 dark:text-blue-200">
                    <i class="fas fa-info-circle mr-2"></i>
                    Market penetration of neurostimulation devices is approximately <strong>${formatNumber(Math.round(data.marketTrends.implantations.total / 990000 * 100), 1)}%</strong> of the refractory epilepsy population.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = journeyHTML;
    logInfo('Patient Journey visualization rendered successfully');
  } catch (error) {
    logError('Error rendering Patient Journey:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render patient journey visualization: ${error.message}</p>
      </div>
    `;
  }
}

// New visualization - Market Penetration
function renderMarketPenetration(data) {
  const containerElement = document.getElementById('market-penetration');
  if (!containerElement) {
    logError('Market Penetration container not found');
    return;
  }
  
  try {
    // Calculate market penetration metrics
    // Based on call transcript: ~1% of population has epilepsy, 30% are refractory
    const usPopulation = 330000000; // Approximate US population
    const epilepsyPopulation = usPopulation * 0.01; // 1% of population
    const refractoryPopulation = epilepsyPopulation * 0.3; // 30% of epilepsy patients
    
    const totalImplantations = data.marketTrends.implantations.total;
    const marketPenetration = (totalImplantations / refractoryPopulation) * 100;
    const untreatedMarket = refractoryPopulation - totalImplantations;
    const potentialMarket = untreatedMarket * data.marketTrends.reimbursement.average;
    
    const marketPenetrationHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-bullseye mr-2 text-marcomm-orange"></i>
          Market Penetration Analysis
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Market Size Stats -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <h4 class="text-lg font-semibold text-marcomm-dark dark:text-white mb-3">Market Size</h4>
            
            <div class="space-y-4">
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-gray-600 dark:text-gray-300">U.S. Population</span>
                  <span class="text-sm font-medium text-marcomm-dark dark:text-white">${formatNumber(usPopulation)}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5">
                  <div class="bg-marcomm-orange h-1.5 rounded-full" style="width: 100%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-gray-600 dark:text-gray-300">Epilepsy Patients (1%)</span>
                  <span class="text-sm font-medium text-marcomm-dark dark:text-white">${formatNumber(epilepsyPopulation)}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5">
                  <div class="bg-marcomm-orange h-1.5 rounded-full" style="width: 1%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-gray-600 dark:text-gray-300">Refractory Patients (30% of Epilepsy)</span>
                  <span class="text-sm font-medium text-marcomm-dark dark:text-white">${formatNumber(refractoryPopulation)}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5">
                  <div class="bg-marcomm-orange h-1.5 rounded-full" style="width: 30%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-gray-600 dark:text-gray-300">Patients with Implants</span>
                  <span class="text-sm font-medium text-marcomm-dark dark:text-white">${formatNumber(totalImplantations)}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5">
                  <div class="bg-marcomm-orange h-1.5 rounded-full" style="width: ${marketPenetration}%"></div>
                </div>
              </div>
            </div>
            
            <div class="mt-4 bg-marcomm-orange bg-opacity-10 p-3 rounded">
              <p class="text-sm">
                <strong>Current Market Penetration:</strong> ${formatNumber(marketPenetration, 2)}% of refractory epilepsy patients
              </p>
            </div>
          </div>
          
          <!-- Market Opportunity -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <h4 class="text-lg font-semibold text-marcomm-dark dark:text-white mb-3">Market Opportunity</h4>
            
            <div class="space-y-4">
              <div class="flex items-center p-3 bg-gray-100 dark:bg-gray-800 rounded">
                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-500 bg-opacity-20 text-green-500 dark:text-green-400 flex items-center justify-center">
                  <i class="fas fa-users text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm text-gray-600 dark:text-gray-300">Untreated Refractory Patients</p>
                  <p class="text-xl font-semibold text-marcomm-dark dark:text-white">${formatNumber(untreatedMarket)}</p>
                </div>
              </div>
              
              <div class="flex items-center p-3 bg-gray-100 dark:bg-gray-800 rounded">
                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-500 bg-opacity-20 text-blue-500 dark:text-blue-400 flex items-center justify-center">
                  <i class="fas fa-dollar-sign text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm text-gray-600 dark:text-gray-300">Avg. Reimbursement Per Patient</p>
                  <p class="text-xl font-semibold text-marcomm-dark dark:text-white">${formatCurrency(data.marketTrends.reimbursement.average)}</p>
                </div>
              </div>
              
              <div class="flex items-center p-3 bg-gray-100 dark:bg-gray-800 rounded">
                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-purple-500 bg-opacity-20 text-purple-500 dark:text-purple-400 flex items-center justify-center">
                  <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div class="ml-4">
                  <p class="text-sm text-gray-600 dark:text-gray-300">Potential Market Value</p>
                  <p class="text-xl font-semibold text-marcomm-dark dark:text-white">${formatCurrency(potentialMarket, 0)}</p>
                </div>
              </div>
            </div>
            
            <div class="mt-4 bg-green-500 bg-opacity-10 p-3 rounded">
              <p class="text-sm text-green-800 dark:text-green-200">
                <i class="fas fa-info-circle mr-2"></i>
                Current penetration rate suggests significant growth opportunity with <strong>${formatNumber(untreatedMarket)}</strong> potential patients remaining.
              </p>
            </div>
          </div>
        </div>
        
        <!-- Growth Projections -->
        <div class="mt-6 bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
          <h4 class="text-lg font-semibold text-marcomm-dark dark:text-white mb-3">Growth Projections</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded">
              <h5 class="text-sm text-gray-600 dark:text-gray-300 mb-2">Conservative (1% Annual)</h5>
              <div class="space-y-2">
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 1</span>
                    <span>${formatNumber(totalImplantations * 1.01)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-blue-500 h-1 rounded-full" style="width: ${marketPenetration * 1.01}%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 3</span>
                    <span>${formatNumber(totalImplantations * 1.03)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-blue-500 h-1 rounded-full" style="width: ${marketPenetration * 1.03}%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 5</span>
                    <span>${formatNumber(totalImplantations * 1.05)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-blue-500 h-1 rounded-full" style="width: ${marketPenetration * 1.05}%"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded">
              <h5 class="text-sm text-gray-600 dark:text-gray-300 mb-2">Moderate (5% Annual)</h5>
              <div class="space-y-2">
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 1</span>
                    <span>${formatNumber(totalImplantations * 1.05)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-green-500 h-1 rounded-full" style="width: ${marketPenetration * 1.05}%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 3</span>
                    <span>${formatNumber(totalImplantations * 1.15)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-green-500 h-1 rounded-full" style="width: ${marketPenetration * 1.15}%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 5</span>
                    <span>${formatNumber(totalImplantations * 1.25)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-green-500 h-1 rounded-full" style="width: ${marketPenetration * 1.25}%"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded">
              <h5 class="text-sm text-gray-600 dark:text-gray-300 mb-2">Aggressive (10% Annual)</h5>
              <div class="space-y-2">
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 1</span>
                    <span>${formatNumber(totalImplantations * 1.1)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-marcomm-orange h-1 rounded-full" style="width: ${marketPenetration * 1.1}%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 3</span>
                    <span>${formatNumber(totalImplantations * 1.3)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-marcomm-orange h-1 rounded-full" style="width: ${marketPenetration * 1.3}%"></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-xs">
                    <span>Year 5</span>
                    <span>${formatNumber(totalImplantations * 1.5)} patients</span>
                  </div>
                  <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-1">
                    <div class="bg-marcomm-orange h-1 rounded-full" style="width: ${marketPenetration * 1.5}%"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-4 text-xs text-gray-500 dark:text-gray-400 italic text-center">
            Note: Projections assume stable refractory population size and no new market entrants
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = marketPenetrationHTML;
    logInfo('Market Penetration visualization rendered successfully');
  } catch (error) {
    logError('Error rendering Market Penetration:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render market penetration visualization: ${error.message}</p>
      </div>
    `;
  }
}

// Continuing from previous artifact - Competitive Insights

function renderCompetitiveInsights(data) {
  const containerElement = document.getElementById('competitive-insights');
  if (!containerElement) {
    logError('Competitive Insights container not found');
    return;
  }
  
  try {
    // Get competitors and sort by market share
    const competitors = [...data.competitors].sort((a, b) => {
      const aShare = data.marketTrends.marketShares[a.name]?.total || 0;
      const bShare = data.marketTrends.marketShares[b.name]?.total || 0;
      return bShare - aShare;
    });
    
    // Generate insights based on the data
    const insights = [];
    
    // Market leader insight
    if (competitors.length > 0) {
      const leader = competitors[0];
      const leaderShare = data.marketTrends.marketShares[leader.name]?.total || 0;
      insights.push({
        title: "Market Leadership",
        icon: "trophy",
        color: "yellow",
        content: `${leader.name} leads the market with ${formatNumber(leaderShare, 1)}% share using ${leader.treatment}.`
      });
    }
    
    // Market growth insight
    if (data.marketTrends.implantations.cagr) {
      const cagr = data.marketTrends.implantations.cagr;
      let growthAssessment = "steady";
      let growthColor = "blue";
      
      if (cagr >= 10) {
        growthAssessment = "rapid";
        growthColor = "green";
      } else if (cagr <= 2) {
        growthAssessment = "slow";
        growthColor = "orange";
      }
      
      insights.push({
        title: "Market Growth",
        icon: "chart-line",
        color: growthColor,
        content: `The epilepsy treatment market shows ${growthAssessment} growth with a ${formatNumber(cagr, 1)}% CAGR.`
      });
    }
    
    // Reimbursement insight
    const avgReimbursement = data.marketTrends.reimbursement.average;
    if (avgReimbursement) {
      insights.push({
        title: "Reimbursement",
        icon: "dollar-sign",
        color: "green",
        content: `Average reimbursement of ${formatCurrency(avgReimbursement)} with potential for ${formatCurrency(avgReimbursement * 0.85)} - ${formatCurrency(avgReimbursement * 1.15)} range based on provider and geography.`
      });
    }
    
    // Provider insights
    const totalProviders = competitors.reduce((sum, comp) => sum + (comp.providers?.unique || 0), 0);
    if (totalProviders > 0) {
      insights.push({
        title: "Provider Network",
        icon: "user-md",
        color: "purple",
        content: `${formatNumber(totalProviders)} unique healthcare providers perform these procedures, with an average of ${formatNumber(data.marketTrends.implantations.total / totalProviders, 1)} procedures per provider.`
      });
    }
    
    // Market penetration insight
    const refractoryPopulation = 990000; // From the patient journey
    const marketPenetration = (data.marketTrends.implantations.total / refractoryPopulation) * 100;
    
    insights.push({
      title: "Market Penetration",
      icon: "bullseye",
      color: "red",
      content: `Current neurostimulation technologies reach only ${formatNumber(marketPenetration, 1)}% of refractory epilepsy patients, indicating significant growth opportunity.`
    });
    
    // Competitive landscape insight
    insights.push({
      title: "Competitive Landscape",
      icon: "chess",
      color: "blue",
      content: `The market is dominated by ${competitors.length} major players with specialized treatment modalities targeting different patient segments and physician preferences.`
    });
    
    // Generate HTML for insights
    const insightsHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-lightbulb mr-2 text-marcomm-orange"></i>
          Competitive Insights
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${insights.map(insight => `
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300">
              <div class="flex items-start">
                <div class="flex-shrink-0 p-2 rounded-full bg-${insight.color}-500 bg-opacity-20 text-${insight.color}-500 dark:text-${insight.color}-400">
                  <i class="fas fa-${insight.icon} text-lg"></i>
                </div>
                <div class="ml-4">
                  <h4 class="text-lg font-medium text-marcomm-dark dark:text-white">${insight.title}</h4>
                  <p class="text-gray-600 dark:text-gray-300 mt-1">${insight.content}</p>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="mt-6 bg-blue-100 dark:bg-blue-900 bg-opacity-50 dark:bg-opacity-20 p-4 rounded-lg">
          <h4 class="font-medium text-blue-800 dark:text-blue-200 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Strategic Considerations
          </h4>
          <ul class="mt-2 text-blue-800 dark:text-blue-200 space-y-2">
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-1 mr-2 text-green-500"></i>
              <span>Focus on expanding the total market by increasing awareness of neurostimulation among neurologists treating refractory patients.</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-1 mr-2 text-green-500"></i>
              <span>Consider partnerships with established providers to accelerate market adoption and leverage existing physician relationships.</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-1 mr-2 text-green-500"></i>
              <span>Highlight differentiated features compared to invasive implantable alternatives to capture market share in the growing neuromodulation segment.</span>
            </li>
          </ul>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = insightsHTML;
    logInfo('Competitive Insights rendered successfully');
  } catch (error) {
    logError('Error rendering Competitive Insights:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render competitive insights: ${error.message}</p>
      </div>
    `;
  }
}

// Add a function for early-stage competitors analysis
function renderEarlyStageCompetitors(data) {
  const containerElement = document.getElementById('early-stage-competitors');
  if (!containerElement) {
    logError('Early Stage Competitors container not found');
    return;
  }
  
  try {
    // Extract early-stage competitors from the call transcript
    const earlyStageCompetitors = [
      {
        name: "Precisis AG",
        treatment: "EASEE",
        description: "Extracranial Focal Electrical Stimulation",
        status: "CE Mark in Europe",
        fundingStage: "Series B",
        keyDifferentiator: "Non-invasive epilepsy therapy using skull-mounted electrodes"
      },
      {
        name: "Epi-Minder",
        treatment: "Seizure Monitoring",
        description: "Continuous sub-scalp EEG monitoring",
        status: "Clinical Trials",
        fundingStage: "Series A",
        keyDifferentiator: "Long-term monitoring for accurate seizure detection and tracking"
      },
      {
        name: "Flow Medical",
        treatment: "Depression Device",
        description: "Non-invasive brain stimulation",
        status: "Early Commercial",
        fundingStage: "Venture-backed",
        keyDifferentiator: "Targeting depression treatment with potential epilepsy applications"
      }
    ];
    
    // Generate HTML for early-stage competitors
    const earlyStageHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-rocket mr-2 text-marcomm-orange"></i>
          Early-Stage Competitors
        </h3>
        
        <div class="overflow-hidden bg-white dark:bg-gray-700 rounded-lg shadow-sm">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
              <thead class="bg-gray-100 dark:bg-gray-800">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Company</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Treatment</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Key Differentiator</th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Threat Level</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
                ${earlyStageCompetitors.map((comp, index) => {
                  // Determine threat level
                  let threatLevel = "Medium";
                  let threatColor = "yellow";
                  
                  if (comp.name === "Precisis AG") {
                    threatLevel = "High";
                    threatColor = "red";
                  } else if (comp.name === "Flow Medical") {
                    threatLevel = "Low";
                    threatColor = "green";
                  }
                  
                  return `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-800' : ''}">
                      <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                          <div class="flex-shrink-0 h-10 w-10 rounded-full bg-marcomm-orange-light bg-opacity-20 flex items-center justify-center">
                            <span class="text-marcomm-orange font-semibold">${comp.name.substring(0, 2)}</span>
                          </div>
                          <div class="ml-4">
                            <div class="text-sm font-medium text-marcomm-dark dark:text-white">${comp.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${comp.fundingStage}</div>
                          </div>
                        </div>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 dark:text-gray-100">${comp.treatment}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${comp.description}</div>
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                          ${comp.status}
                        </span>
                      </td>
                      <td class="px-4 py-4 text-sm text-gray-700 dark:text-gray-300">
                        ${comp.keyDifferentiator}
                      </td>
                      <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${threatColor}-100 dark:bg-${threatColor}-900 text-${threatColor}-800 dark:text-${threatColor}-200">
                          ${threatLevel}
                        </span>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="mt-4 bg-gray-100 dark:bg-gray-800 p-3 rounded">
          <h4 class="font-medium text-gray-700 dark:text-gray-200 mb-2">Patent Activity</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 bg-opacity-20 text-blue-500 dark:text-blue-400 flex items-center justify-center">
                <i class="fas fa-file-signature"></i>
              </div>
              <div class="ml-3">
                <p class="text-xs text-gray-500 dark:text-gray-400">Precisis AG</p>
                <p class="text-sm font-medium">12 patents</p>
              </div>
            </div>
            <div class="flex items-center bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 bg-opacity-20 text-blue-500 dark:text-blue-400 flex items-center justify-center">
                <i class="fas fa-file-signature"></i>
              </div>
              <div class="ml-3">
                <p class="text-xs text-gray-500 dark:text-gray-400">Epi-Minder</p>
                <p class="text-sm font-medium">8 patents</p>
              </div>
            </div>
            <div class="flex items-center bg-white dark:bg-gray-700 p-2 rounded shadow-sm">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 bg-opacity-20 text-blue-500 dark:text-blue-400 flex items-center justify-center">
                <i class="fas fa-file-signature"></i>
              </div>
              <div class="ml-3">
                <p class="text-xs text-gray-500 dark:text-gray-400">Flow Medical</p>
                <p class="text-sm font-medium">5 patents</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = earlyStageHTML;
    logInfo('Early Stage Competitors rendered successfully');
  } catch (error) {
    logError('Error rendering Early Stage Competitors:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render early stage competitors: ${error.message}</p>
      </div>
    `;
  }
}

// Continuing the Regulatory Landscape section

// Continuing the regulatory updates section that was cut off
function renderRegulatoryLandscape(data) {
  const containerElement = document.getElementById('regulatory-landscape');
  if (!containerElement) {
    logError('Regulatory Landscape container not found');
    return;
  }
  
  try {
    // Extract the competitors and their regulatory data
    const competitors = data.competitors;
    
    // Generate HTML for regulatory landscape
    const regulatoryHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-balance-scale mr-2 text-marcomm-orange"></i>
          Regulatory Landscape
        </h3>
        
        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm mb-4">
          <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-2">FDA Pathways for Neurostimulation Devices</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="border border-blue-200 dark:border-blue-800 rounded-lg overflow-hidden">
              <div class="bg-blue-100 dark:bg-blue-900 p-3">
                <h5 class="font-medium text-blue-800 dark:text-blue-200">PMA</h5>
                <p class="text-xs text-blue-600 dark:text-blue-300">Premarket Approval</p>
              </div>
              <div class="p-3">
                <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-2">
                  <li class="flex items-start">
                    <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                    <span>Required for Class III devices</span>
                  </li>
                  <li class="flex items-start">
                    <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                    <span>Most implantable stimulators</span>
                  </li>
                  <li class="flex items-start">
                    <i class="fas fa-clock text-gray-500 mt-1 mr-2"></i>
                    <span>Longest timeline (1-3 years)</span>
                  </li>
                </ul>
              </div>
            </div>
            
            <div class="border border-purple-200 dark:border-purple-800 rounded-lg overflow-hidden">
              <div class="bg-purple-100 dark:bg-purple-900 p-3">
                <h5 class="font-medium text-purple-800 dark:text-purple-200">De Novo</h5>
                <p class="text-xs text-purple-600 dark:text-purple-300">Novel Device Pathway</p>
              </div>
              <div class="p-3">
                <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-2">
                  <li class="flex items-start">
                    <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                    <span>For novel devices with no predicate</span>
                  </li>
                  <li class="flex items-start">
                    <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                    <span>Moderate to low risk (Class I or II)</span>
                  </li>
                  <li class="flex items-start">
                    <i class="fas fa-clock text-gray-500 mt-1 mr-2"></i>
                    <span>Intermediate timeline (9-18 months)</span>
                  </li>
                </ul>
              </div>
            </div>
            
            <div class="border border-green-200 dark:border-green-800 rounded-lg overflow-hidden">
              <div class="bg-green-100 dark:bg-green-900 p-3">
                <h5 class="font-medium text-green-800 dark:text-green-200">510(k)</h5>
                <p class="text-xs text-green-600 dark:text-green-300">Substantial Equivalence</p>
              </div>
              <div class="p-3">
                <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-2">
                  <li class="flex items-start">
                    <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                    <span>For devices similar to legally marketed devices</span>
                  </li>
                  <li class="flex items-start">
                    <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                    <span>Most non-implantable neurostimulators</span>
                  </li>
                  <li class="flex items-start">
                    <i class="fas fa-clock text-gray-500 mt-1 mr-2"></i>
                    <span>Shorter timeline (3-6 months)</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-2">Common CPT Codes</h4>
            
            <div class="overflow-hidden border border-gray-200 dark:border-gray-800 rounded-lg">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-800">
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Code</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Description</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Avg. Reimb.</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                  <tr>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">64568</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">Implantation of cranial nerve stimulator</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300 text-right">${formatCurrency(35400)}</td>
                  </tr>
                  <tr class="bg-gray-50 dark:bg-gray-800">
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">61863</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">Twisting drill or burr hole with stereotactic implantation</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300 text-right">${formatCurrency(28900)}</td>
                  </tr>
                  <tr>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">61885</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">Insertion of neurostimulator pulse generator</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300 text-right">${formatCurrency(26700)}</td>
                  </tr>
                  <tr class="bg-gray-50 dark:bg-gray-800">
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">61886</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300">Insertion of neurostimulator pulse generator (complex)</td>
                    <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300 text-right">${formatCurrency(39200)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-2">FDA Approval Status</h4>
            
            <div class="space-y-3">
              ${competitors.map(comp => {
                let approvalStatus = "Approved";
                let approvalYear = "2018";
                let indicationText = "Epilepsy";
                let statusColor = "green";
                
                if (comp.name === "LivaNova") {
                  approvalYear = "1997";
                  indicationText = "Drug-resistant epilepsy";
                } else if (comp.name === "Medtronic") {
                  approvalYear = "2018";
                  indicationText = "Drug-resistant epilepsy, Parkinson's";
                } else if (comp.name === "NeuroPace") {
                  approvalYear = "2013";
                  indicationText = "Refractory epilepsy with partial onset seizures";
                }
                
                return `
                  <div class="flex items-center justify-between p-3 border border-gray-200 dark:border-gray-600 rounded-lg">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-${statusColor}-100 dark:bg-${statusColor}-900 flex items-center justify-center">
                        <i class="fas fa-check text-${statusColor}-600 dark:text-${statusColor}-400"></i>
                      </div>
                      <div class="ml-3">
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-200">${comp.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${indicationText}</p>
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-sm font-medium text-${statusColor}-600 dark:text-${statusColor}-400">${approvalStatus}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">Since ${approvalYear}</p>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
          <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-2">Recent Regulatory Updates</h4>
          
          <div class="mt-3 space-y-3">
            <div class="flex items-start p-3 bg-blue-50 dark:bg-blue-900 bg-opacity-50 dark:bg-opacity-20 rounded-lg">
              <div class="flex-shrink-0 mt-0.5">
                <i class="fas fa-bell text-blue-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-200">FDA Issues Final Guidance on Brain-Computer Interfaces</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">February 2023</p>
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">New guidance clarifies regulatory pathways for non-invasive brain-computer interfaces, potentially accelerating approval for certain neurostimulation devices.</p>
              </div>
            </div>
            
            <div class="flex items-start p-3 bg-green-50 dark:bg-green-900 bg-opacity-50 dark:bg-opacity-20 rounded-lg">
              <div class="flex-shrink-0 mt-0.5">
                <i class="fas fa-file-prescription text-green-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-200">CMS Expands Reimbursement for Remote Monitoring</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">November 2022</p>
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">New CPT codes and expanded coverage for remote therapeutic monitoring, relevant for managing patients with epilepsy using neurostimulation devices.</p>
              </div>
            </div>
            
            <div class="flex items-start p-3 bg-purple-50 dark:bg-purple-900 bg-opacity-50 dark:bg-opacity-20 rounded-lg">
              <div class="flex-shrink-0 mt-0.5">
                <i class="fas fa-clipboard-check text-purple-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-200">Breakthrough Device Designation Issued for Novel Epilepsy Technology</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">January 2023</p>
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">FDA grants Breakthrough Device designation to a non-invasive neuromodulation technology for refractory epilepsy patients, potentially accelerating its path to market.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = regulatoryHTML;
    logInfo('Regulatory Landscape rendered successfully');
  } catch (error) {
    logError('Error rendering Regulatory Landscape:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render regulatory landscape: ${error.message}</p>
      </div>
    `;
  }
}

// Add function for Provider Distribution by Geography
function renderProviderGeography(data) {
  const containerElement = document.getElementById('provider-geography');
  if (!containerElement) {
    logError('Provider Geography container not found');
    return;
  }
  
  try {
    // Generate mock data for geographic distribution
    // In a real application, this would come from the backend
    const geographicData = {
      regions: [
        { name: "Northeast", percentage: 28, providers: 1240, growth: 7.5 },
        { name: "Midwest", percentage: 22, providers: 980, growth: 5.2 },
        { name: "South", percentage: 32, providers: 1420, growth: 9.8 },
        { name: "West", percentage: 18, providers: 800, growth: 6.3 }
      ],
      topStates: [
        { name: "California", providers: 520, percentage: 12 },
        { name: "Texas", providers: 480, percentage: 11 },
        { name: "New York", providers: 390, percentage: 9 },
        { name: "Florida", providers: 350, percentage: 8 },
        { name: "Pennsylvania", providers: 210, percentage: 5 }
      ],
      urbanRural: {
        urban: 76,
        suburban: 18,
        rural: 6
      }
    };
    
    // Generate HTML
    const geographyHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-map-marked-alt mr-2 text-marcomm-orange"></i>
          Provider Geographic Distribution
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Regional Distribution -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-3">Regional Distribution</h4>
            
            <div class="space-y-4">
              ${geographicData.regions.map(region => {
                let colorClass = "blue";
                if (region.name === "South") colorClass = "marcomm-orange";
                if (region.name === "Northeast") colorClass = "green";
                if (region.name === "West") colorClass = "purple";
                
                return `
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">${region.name}</span>
                        ${region.growth > 8 ? `
                          <span class="ml-2 px-1.5 py-0.5 text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded">
                            +${region.growth}%
                          </span>
                        ` : ''}
                      </div>
                      <div class="flex items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-300 mr-2">${region.providers} providers</span>
                        <span class="text-sm font-medium text-${colorClass}-600 dark:text-${colorClass}-400">${region.percentage}%</span>
                      </div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-2">
                      <div class="bg-${colorClass}-500 h-2 rounded-full" style="width: ${region.percentage}%"></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 bg-opacity-50 dark:bg-opacity-20 rounded text-sm text-blue-800 dark:text-blue-200">
              <i class="fas fa-info-circle mr-1"></i>
              The South shows the highest concentration of providers and fastest growth rate (+9.8%), suggesting strong market adoption.
            </div>
          </div>
          
          <!-- Top States -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-3">Top States by Provider Count</h4>
            
            <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-800">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
                <thead class="bg-gray-50 dark:bg-gray-800">
                  <tr>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">State</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Providers</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Share</th>
                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Visualization</th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-800">
                  ${geographicData.topStates.map((state, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-gray-50 dark:bg-gray-800' : ''}">
                      <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-700 dark:text-gray-200">${state.name}</td>
                      <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">${formatNumber(state.providers)}</td>
                      <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">${state.percentage}%</td>
                      <td class="px-3 py-2 whitespace-nowrap">
                        <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5">
                          <div class="bg-marcomm-orange h-1.5 rounded-full" style="width: ${state.percentage * 5}%"></div>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div class="mt-4 grid grid-cols-3 gap-2">
              <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400">Urban</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${geographicData.urbanRural.urban}%</p>
              </div>
              <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400">Suburban</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${geographicData.urbanRural.suburban}%</p>
              </div>
              <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400">Rural</p>
                <p class="text-lg font-semibold text-marcomm-dark dark:text-white">${geographicData.urbanRural.rural}%</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Provider Growth Forecast -->
        <div class="mt-6 bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
          <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-3">Provider Network Growth Forecast</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-500 dark:text-gray-400">Current</p>
              <p class="text-xl font-bold text-marcomm-dark dark:text-white">${formatNumber(4440)}</p>
              <p class="text-xs text-gray-600 dark:text-gray-300">providers</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-500 dark:text-gray-400">Year 1</p>
              <p class="text-xl font-bold text-marcomm-dark dark:text-white">${formatNumber(4840)}</p>
              <p class="text-xs text-green-600 dark:text-green-400">+9% growth</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-500 dark:text-gray-400">Year 3</p>
              <p class="text-xl font-bold text-marcomm-dark dark:text-white">${formatNumber(5770)}</p>
              <p class="text-xs text-green-600 dark:text-green-400">+30% growth</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
              <p class="text-xs text-gray-500 dark:text-gray-400">Year 5</p>
              <p class="text-xl font-bold text-marcomm-dark dark:text-white">${formatNumber(7100)}</p>
              <p class="text-xs text-green-600 dark:text-green-400">+60% growth</p>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-green-50 dark:bg-green-900 bg-opacity-50 dark:bg-opacity-20 rounded">
            <p class="text-sm text-green-800 dark:text-green-200">
              <i class="fas fa-lightbulb mr-2"></i>
              <strong>Strategy Insight:</strong> Focus provider acquisition efforts in the South and West regions where growth rates are highest. Consider partnerships with key medical centers in California and Texas to accelerate adoption.
            </p>
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = geographyHTML;
    logInfo('Provider Geography rendered successfully');
  } catch (error) {
    logError('Error rendering Provider Geography:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render provider geography: ${error.message}</p>
      </div>
    `;
  }
}

// Continuing the Strategic Recommendations section

function renderStrategicRecommendations(data) {
  const containerElement = document.getElementById('strategic-recommendations');
  if (!containerElement) {
    logError('Strategic Recommendations container not found');
    return;
  }
  
  try {
    // Calculate market penetration for insight generation
    const usPopulation = 330000000;
    const epilepsyPopulation = usPopulation * 0.01;
    const refractoryPopulation = epilepsyPopulation * 0.3;
    const totalImplantations = data.marketTrends.implantations.total;
    const marketPenetration = (totalImplantations / refractoryPopulation) * 100;
    
    // Generate recommendations based on data insights
    const recommendationsHTML = `
      <div class="p-4">
        <h3 class="text-xl font-light text-marcomm-dark mb-4 dark:text-white flex items-center">
          <i class="fas fa-chess-knight mr-2 text-marcomm-orange"></i>
          Strategic Recommendations
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Market Opportunity -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <div class="flex items-center mb-3">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-marcomm-orange bg-opacity-20 flex items-center justify-center text-marcomm-orange">
                <i class="fas fa-bullseye"></i>
              </div>
              <h4 class="ml-3 text-lg font-medium text-marcomm-dark dark:text-white">Market Opportunity</h4>
            </div>
            
            <div class="space-y-3">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Target the untreated <strong>${formatNumber(refractoryPopulation - totalImplantations)}</strong> refractory epilepsy patients, representing a <strong>${formatCurrency((refractoryPopulation - totalImplantations) * data.marketTrends.reimbursement.average, 0)}</strong> market opportunity.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Position as complementary to medication therapy, targeting the 30% of patients who remain refractory after trying multiple anti-seizure medications.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Leverage non-invasive approach as a key differentiator against the current market leaders who all require surgical implantation, which is a barrier for many patients.</p>
                </div>
              </div>
              
              <div class="border-t border-gray-200 dark:border-gray-600 my-3 pt-3">
                <p class="text-xs text-blue-600 dark:text-blue-400 uppercase font-semibold mb-2">Key Insight</p>
                <p class="text-sm text-gray-700 dark:text-gray-200 italic">With only ${formatNumber(marketPenetration, 1)}% current market penetration of refractory patients, there is significant room for growth even without taking market share from established competitors.</p>
              </div>
            </div>
          </div>
          
          <!-- Competitive Positioning -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <div class="flex items-center mb-3">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 bg-opacity-20 flex items-center justify-center text-blue-500">
                <i class="fas fa-chess"></i>
              </div>
              <h4 class="ml-3 text-lg font-medium text-marcomm-dark dark:text-white">Competitive Positioning</h4>
            </div>
            
            <div class="space-y-3">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Differentiate from LivaNova (VNS) by emphasizing more precise targeting and reduced side effects compared to vagus nerve stimulation.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Position against Medtronic (DBS) by highlighting non-invasive approach, avoiding brain surgery risks, and significantly lower procedural costs.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Counter NeuroPace (RNS) by emphasizing non-implantable technology, lower upfront costs, and ability to adjust or discontinue therapy without additional surgeries.</p>
                </div>
              </div>
              
              <div class="border-t border-gray-200 dark:border-gray-600 my-3 pt-3">
                <p class="text-xs text-blue-600 dark:text-blue-400 uppercase font-semibold mb-2">Key Insight</p>
                <p class="text-sm text-gray-700 dark:text-gray-200 italic">Focus on creating a new market segment rather than directly competing with established players—position as "first-line neuromodulation" before patients consider invasive options.</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Go-to-Market Strategy -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <div class="flex items-center mb-3">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500 bg-opacity-20 flex items-center justify-center text-purple-500">
                <i class="fas fa-rocket"></i>
              </div>
              <h4 class="ml-3 text-lg font-medium text-marcomm-dark dark:text-white">Go-to-Market Strategy</h4>
            </div>
            
            <div class="space-y-3">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Target the South and West regions first, which show the highest growth rates in neurostimulation adoption, followed by expansion to the Northeast.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Focus initial provider outreach on the top 5 states (CA, TX, NY, FL, PA) which represent 45% of all providers performing neurostimulation procedures.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Pursue the 510(k) regulatory pathway for faster market entry, leveraging predicate devices while emphasizing unique differentiators.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Develop remote monitoring capabilities to align with recent CMS reimbursement expansion for telehealth and remote therapeutic monitoring.</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Pricing & Reimbursement -->
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
            <div class="flex items-center mb-3">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-500 bg-opacity-20 flex items-center justify-center text-green-500">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <h4 class="ml-3 text-lg font-medium text-marcomm-dark dark:text-white">Pricing & Reimbursement</h4>
            </div>
            
            <div class="space-y-3">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Position device at a price point of ${formatCurrency(data.marketTrends.reimbursement.average * 0.6)}, significantly below implantable alternatives while maintaining healthy margins.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Develop a comprehensive reimbursement strategy targeting both existing CPT codes and pursuing new codes that reflect the non-invasive nature of the technology.</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 mt-0.5">
                  <i class="fas fa-check text-sm"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-gray-700 dark:text-gray-200">Consider a subscription model or maintenance contract approach to generate recurring revenue beyond the initial device sale.</p>
                </div>
              </div>
              
              <div class="border-t border-gray-200 dark:border-gray-600 my-3 pt-3">
                <p class="text-xs text-blue-600 dark:text-blue-400 uppercase font-semibold mb-2">Cost-Effectiveness Analysis</p>
                <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded">
                  <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="text-right text-gray-500 dark:text-gray-400">Surgery Costs Avoided:</div>
                    <div class="font-medium text-gray-700 dark:text-gray-200">${formatCurrency(30000)}</div>
                    <div class="text-right text-gray-500 dark:text-gray-400">Hospitalization Savings:</div>
                    <div class="font-medium text-gray-700 dark:text-gray-200">${formatCurrency(15000)}</div>
                    <div class="text-right text-gray-500 dark:text-gray-400">Device Price Delta:</div>
                    <div class="font-medium text-gray-700 dark:text-gray-200">${formatCurrency(20000)}</div>
                    <div class="text-right text-gray-500 dark:text-gray-400 font-medium">Total Savings:</div>
                    <div class="font-medium text-green-600 dark:text-green-400">${formatCurrency(65000)}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Plan Timeline -->
        <div class="mt-6 bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
          <h4 class="text-lg font-medium text-marcomm-dark dark:text-white mb-3">Strategic Roadmap</h4>
          
          <div class="relative">
            <!-- Timeline -->
            <div class="absolute left-8 top-0 h-full w-1 bg-gray-300 dark:bg-gray-600"></div>
            
            <!-- Q1 2023 -->
            <div class="relative mb-6">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-marcomm-orange text-white flex items-center justify-center z-10">
                  <span class="text-xs font-medium">Q1</span>
                </div>
                <div class="ml-6 bg-marcomm-orange bg-opacity-5 dark:bg-opacity-10 p-3 rounded-lg border-l-4 border-marcomm-orange">
                  <h5 class="text-base font-medium text-marcomm-dark dark:text-white">Regulatory & Market Positioning</h5>
                  <ul class="mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-1">
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-marcomm-orange"></i>
                      <span>Submit FDA 510(k) application with clinical data</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-marcomm-orange"></i>
                      <span>Finalize competitive positioning strategy</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-marcomm-orange"></i>
                      <span>Develop reimbursement strategy with outside consultants</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Q2 2023 -->
            <div class="relative mb-6">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center z-10">
                  <span class="text-xs font-medium">Q2</span>
                </div>
                <div class="ml-6 bg-blue-500 bg-opacity-5 dark:bg-opacity-10 p-3 rounded-lg border-l-4 border-blue-500">
                  <h5 class="text-base font-medium text-marcomm-dark dark:text-white">Clinical Strategy & KOL Development</h5>
                  <ul class="mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-1">
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-blue-500"></i>
                      <span>Begin recruiting KOLs in target regions (South/West)</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-blue-500"></i>
                      <span>Initiate post-market clinical study for publication</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-blue-500"></i>
                      <span>Prepare presentations for annual neurology conferences</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Q3 2023 -->
            <div class="relative mb-6">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center z-10">
                  <span class="text-xs font-medium">Q3</span>
                </div>
                <div class="ml-6 bg-green-500 bg-opacity-5 dark:bg-opacity-10 p-3 rounded-lg border-l-4 border-green-500">
                  <h5 class="text-base font-medium text-marcomm-dark dark:text-white">Commercial Launch</h5>
                  <ul class="mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-1">
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-green-500"></i>
                      <span>Limited commercial launch in California and Texas</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-green-500"></i>
                      <span>Deploy dedicated sales team to top 20 epilepsy centers</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-green-500"></i>
                      <span>Launch patient and physician education portal</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Q4 2023 -->
            <div class="relative">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center z-10">
                  <span class="text-xs font-medium">Q4</span>
                </div>
                <div class="ml-6 bg-purple-500 bg-opacity-5 dark:bg-opacity-10 p-3 rounded-lg border-l-4 border-purple-500">
                  <h5 class="text-base font-medium text-marcomm-dark dark:text-white">Expansion & Refinement</h5>
                  <ul class="mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-1">
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-purple-500"></i>
                      <span>Expand to additional markets (NY, FL, PA)</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-purple-500"></i>
                      <span>Analyze initial sales data and refine targeting</span>
                    </li>
                    <li class="flex items-start">
                      <i class="fas fa-caret-right mt-1 mr-2 text-purple-500"></i>
                      <span>Begin development of remote monitoring integration</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = recommendationsHTML;
    logInfo('Strategic Recommendations rendered successfully');
  } catch (error) {
    logError('Error rendering Strategic Recommendations:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render strategic recommendations: ${error.message}</p>
      </div>
    `;
  }
}

// Add function to render a dashboard footer with sources and notes
function renderDashboardFooter() {
  const containerElement = document.getElementById('dashboard-footer');
  if (!containerElement) {
    logError('Dashboard Footer container not found');
    return;
  }
  
  try {
    const footerHTML = `
      <div class="px-4 py-6 bg-gray-100 dark:bg-gray-800 mt-8">
        <div class="max-w-7xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Data Sources -->
            <div>
              <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200 uppercase mb-2">Data Sources</h4>
              <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
                <li class="flex items-start">
                  <i class="fas fa-database text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>Medicare Claims Data (CMS Part B, 2020-2022)</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-database text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>FDA Device Approvals & Adverse Events Database</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-database text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>USPTO Patent Database & Orange Book</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-database text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>Clinical Trials Registry (clinicaltrials.gov)</span>
                </li>
              </ul>
            </div>
            
            <!-- Methodology Notes -->
            <div>
              <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200 uppercase mb-2">Methodology Notes</h4>
              <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
                <li class="flex items-start">
                  <i class="fas fa-info-circle text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>Market size based on 1% epilepsy prevalence, 30% refractory rate</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-info-circle text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>Medicare data extracted using CPT codes for neurostimulation</span>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-info-circle text-xs mt-1 mr-2 text-gray-400"></i>
                  <span>Competitor analysis based on publicly available financial data</span>
                </li>
              </ul>
            </div>
            
            <!-- Resources -->
            <div>
              <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200 uppercase mb-2">Additional Resources</h4>
              <ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
                <li class="flex items-start">
                  <i class="fas fa-file-pdf text-xs mt-1 mr-2 text-gray-400"></i>
                  <a href="#" class="hover:text-marcomm-orange">Download Full Competitive Analysis (PDF)</a>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-file-excel text-xs mt-1 mr-2 text-gray-400"></i>
                  <a href="#" class="hover:text-marcomm-orange">Export Data to Excel</a>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-file-medical-alt text-xs mt-1 mr-2 text-gray-400"></i>
                  <a href="#" class="hover:text-marcomm-orange">Regulatory Pathway Reference Guide</a>
                </li>
                <li class="flex items-start">
                  <i class="fas fa-calendar-alt text-xs mt-1 mr-2 text-gray-400"></i>
                  <a href="#" class="hover:text-marcomm-orange">Key Industry Events Calendar</a>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center">
              <div class="text-sm text-gray-500 dark:text-gray-400">
                <p>Last updated: <span id="last-updated-footer">March 19, 2025</span></p>
                <p class="text-xs mt-1">Data refreshed weekly from public sources</p>
              </div>
              <div class="mt-4 md:mt-0">
                <button id="share-dashboard" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-marcomm-orange transition-colors">
                  <i class="fas fa-share-alt mr-2"></i>
                  Share Dashboard
                </button>
                <button id="schedule-refresh" class="ml-3 inline-flex items-center px-3 py-1.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-marcomm-orange hover:bg-marcomm-orange-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-marcomm-orange transition-colors">
                  <i class="fas fa-sync-alt mr-2"></i>
                  Schedule Refresh
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    containerElement.innerHTML = footerHTML;
    logInfo('Dashboard Footer rendered successfully');
    
    // Add event listeners for the footer buttons
    const shareButton = document.getElementById('share-dashboard');
    if (shareButton) {
      shareButton.addEventListener('click', function() {
        alert('Share functionality would be implemented here');
      });
    }
    
    const scheduleButton = document.getElementById('schedule-refresh');
    if (scheduleButton) {
      scheduleButton.addEventListener('click', function() {
        alert('Schedule data refresh functionality would be implemented here');
      });
    }
  } catch (error) {
    logError('Error rendering Dashboard Footer:', error);
    containerElement.innerHTML = `
      <div class="p-4 text-red-500 text-center">
        <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
        <p>Unable to render dashboard footer: ${error.message}</p>
      </div>
    `;
  }
}

// Updating the renderAllSections function to include all new visualizations

// Update the renderAllSections function to include the new visualizations
function renderAllSections(data) {
  // Render Market Overview
  renderMarketOverview(data);
  
  // Render Competitive Map
  renderCompetitiveMap(data);
  
  // Render Quick Stats
  renderQuickStats(data);
  
  // Render all charts
  renderCharts(data);
  
  // Render Competitive Insights
  renderCompetitiveInsights(data);
  
  // Render Patient Journey (visualization based on call transcript)
  renderPatientJourney(data);
  
  // Render Market Penetration (visualization based on call transcript)
  renderMarketPenetration(data);
  
  // Render Early Stage Competitors (new section)
  renderEarlyStageCompetitors(data);
  
  // Render Regulatory Landscape (new section)
  renderRegulatoryLandscape(data);
  
  // Render Provider Geography (new section)
  renderProviderGeography(data);
  
  // Render Strategic Recommendations (new section)
  renderStrategicRecommendations(data);
  
  // Render Dashboard Footer (new section)
  renderDashboardFooter();
  
  // IMPORTANT: Remove all loading indicators after everything is rendered
  setTimeout(() => {
    removeLoadingIndicators();
  }, 500);
}

// Main initialization function to set up dashboard with updated sections
document.addEventListener('DOMContentLoaded', function() {
  // Set up dark mode toggle
  setupDarkMode();
  
  // Configure global Chart.js settings for better dark mode support
  configureChartDefaults();
  
  // Load dashboard data once
  loadDashboardData();
  
  // Attach refresh event listener
  const refreshButton = getElement('refreshData');
  if (refreshButton) {
    refreshButton.addEventListener('click', function() {
      loadDashboardData();
    });
  }
  
  // Add event listeners for any new dashboard navigation items
  setupDashboardNav();
});

// New function to set up dashboard navigation
function setupDashboardNav() {
  const navItems = document.querySelectorAll('.dashboard-nav-item');
  
  navItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Get the target section id
      const targetSection = this.getAttribute('data-target');
      if (!targetSection) return;
      
      // Find the section element
      const sectionElement = document.getElementById(targetSection);
      if (!sectionElement) return;
      
      // Scroll to the section
      sectionElement.scrollIntoView({ behavior: 'smooth' });
      
      // Update active state
      navItems.forEach(navItem => {
        navItem.classList.remove('active');
      });
      this.classList.add('active');
    });
  });
}

// Add a function to generate a printable report
function generatePrintableReport() {
  const reportContainer = document.getElementById('printable-report');
  if (!reportContainer) return;
  
  // Get the dashboard data
  const data = window.dashboardData;
  if (!data) {
    reportContainer.innerHTML = `
      <div class="text-center p-8">
        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
        <p class="text-xl">Dashboard data not available.</p>
        <p class="text-sm text-gray-500 mt-2">Please load the dashboard data first.</p>
      </div>
    `;
    return;
  }
  
  // Generate a printable version of the dashboard with key insights
  try {
    const reportHTML = `
      <div class="bg-white p-8">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-gray-800">Epilepsy Neurostimulation Market Analysis</h1>
          <p class="text-sm text-gray-500">Generated on ${new Date().toLocaleDateString()}</p>
        </div>
        
        <div class="grid grid-cols-2 gap-6 mb-8">
          <div>
            <h2 class="text-xl font-semibold mb-4">Market Overview</h2>
            <p>The epilepsy neurostimulation market represents a significant opportunity with only ${formatNumber(data.marketTrends.implantations.total)} procedures performed annually out of an estimated ${formatNumber(990000)} refractory epilepsy patients in the US.</p>
            <p class="mt-2">Market growth is ${formatNumber(data.marketTrends.implantations.cagr, 1)}% annually with an average reimbursement of ${formatCurrency(data.marketTrends.reimbursement.average)}.</p>
          </div>
          <div>
            <h2 class="text-xl font-semibold mb-4">Competitive Landscape</h2>
            <p>The market is dominated by three key players:</p>
            <ul class="list-disc ml-5 mt-2">
              ${data.competitors.map(comp => `
                <li>${comp.name} (${comp.treatment}) - ${formatNumber(data.marketTrends.marketShares[comp.name]?.total || 0, 1)}% market share</li>
              `).join('')}
            </ul>
          </div>
        </div>
        
        <h2 class="text-xl font-semibold mb-4">Strategic Recommendations</h2>
        <div class="grid grid-cols-2 gap-6 mb-8">
          <div>
            <h3 class="text-lg font-medium mb-2">Market Opportunity</h3>
            <ul class="list-disc ml-5">
              <li>Target the untreated refractory population (${formatNumber(990000 - data.marketTrends.implantations.total)} patients)</li>
              <li>Position as a non-invasive alternative to surgical implants</li>
              <li>Focus initially on high-growth regions (South, West)</li>
            </ul>
          </div>
          <div>
            <h3 class="text-lg font-medium mb-2">Competitive Strategy</h3>
            <ul class="list-disc ml-5">
              <li>Differentiate on non-invasive approach and lower cost</li>
              <li>Target "first-line neuromodulation" positioning</li>
              <li>Focus on reimbursement and provider education</li>
            </ul>
          </div>
        </div>
        
        <div class="border-t border-gray-200 pt-6 mt-6">
          <p class="text-sm text-gray-500 text-center">This report is generated from the Market Intelligence Dashboard</p>
        </div>
      </div>
    `;
    
    reportContainer.innerHTML = reportHTML;
  } catch (error) {
    logError('Error generating printable report:', error);
    reportContainer.innerHTML = `
      <div class="text-center p-8">
        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
        <p class="text-xl">Error generating report</p>
        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
      </div>
    `;
  }
}

// Add export functions for sharing and exporting dashboard data
function exportDashboardData(format) {
  // Get the dashboard data
  const data = window.dashboardData;
  if (!data) {
    alert('Dashboard data not available. Please load the dashboard data first.');
    return;
  }
  
  try {
    switch (format) {
      case 'json':
        // Export as JSON
        const jsonString = JSON.stringify(data, null, 2);
        downloadFile('dashboard_data.json', jsonString, 'application/json');
        break;
        
      case 'csv':
        // Export key metrics as CSV
        let csvContent = 'Competitor,Treatment,Implantations,Market Share,Providers\n';
        
        data.competitors.forEach(comp => {
          csvContent += `${comp.name},${comp.treatment},${comp.implantations.total},${data.marketTrends.marketShares[comp.name]?.total || 0},${comp.providers.unique}\n`;
        });
        
        downloadFile('dashboard_metrics.csv', csvContent, 'text/csv');
        break;
        
      case 'pdf':
        // For PDF, we would typically use a library like jsPDF
        // This is a simplified placeholder
        alert('PDF export would be implemented with a library like jsPDF.');
        break;
        
      default:
        alert('Unsupported export format');
    }
  } catch (error) {
    logError('Error exporting dashboard data:', error);
    alert(`Error exporting data: ${error.message}`);
  }
}

// Helper function to download a file
function downloadFile(filename, content, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  
  setTimeout(() => {
    URL.revokeObjectURL(url);
  }, 100);
}

// Add dashboard search functionality
function setupDashboardSearch() {
  const searchInput = document.getElementById('dashboard-search');
  if (!searchInput) return;
  
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    // If search term is empty, show all sections
    if (!searchTerm) {
      document.querySelectorAll('.dashboard-section').forEach(section => {
        section.style.display = '';
      });
      return;
    }
    
    // Search through sections and competitors
    document.querySelectorAll('.dashboard-section').forEach(section => {
      const sectionTitle = section.querySelector('h3')?.textContent.toLowerCase() || '';
      const sectionContent = section.textContent.toLowerCase();
      
      // Check if section title or content contains the search term
      if (sectionTitle.includes(searchTerm) || sectionContent.includes(searchTerm)) {
        section.style.display = '';
        
        // Highlight matches (optional)
        highlightMatches(section, searchTerm);
      } else {
        section.style.display = 'none';
      }
    });
    
    // Also search through competitor list
    const competitorList = document.getElementById('competitor-list');
    if (competitorList) {
      competitorList.querySelectorAll('li').forEach(item => {
        const itemText = item.textContent.toLowerCase();
        
        if (itemText.includes(searchTerm)) {
          item.style.display = '';
          highlightMatches(item, searchTerm);
        } else {
          item.style.display = 'none';
        }
      });
    }
  });
}

// Helper function to highlight search matches
function highlightMatches(element, searchTerm) {
  // This is a simple implementation and would need to be enhanced for proper text node handling
  const html = element.innerHTML;
  const regex = new RegExp(searchTerm, 'gi');
  
  // Only apply to text nodes, not to complex HTML structures to avoid breaking them
  // A more robust implementation would traverse text nodes specifically
  if (element.children.length === 0) {
    element.innerHTML = html.replace(regex, match => `<mark class="bg-yellow-200 dark:bg-yellow-700">${match}</mark>`);
  }
}

// Add a dashboard refresh animation and status indicator
function showDashboardRefreshing() {
  // Update status indicator
  updateConnectionStatus('loading');
  
  // Show loading indicators
  document.querySelectorAll('.loader-container').forEach(loader => {
    loader.classList.remove('hidden');
  });
  
  // Add a subtle background animation to the entire dashboard
  const dashboard = document.getElementById('dashboard-container');
  if (dashboard) {
    dashboard.classList.add('dashboard-refreshing');
    
    // Remove the class after refreshing is complete
    setTimeout(() => {
      dashboard.classList.remove('dashboard-refreshing');
    }, 1500);
  }
}

// Ensure all new sections have loading indicators
function addLoadingIndicatorsToNewSections() {
  const newSections = [
    'patient-journey',
    'market-penetration',
    'early-stage-competitors',
    'regulatory-landscape',
    'provider-geography',
    'strategic-recommendations'
  ];
  
  newSections.forEach(sectionId => {
    const section = document.getElementById(sectionId);
    if (!section) return;
    
    // Check if section already has a loading indicator
    if (!section.querySelector('.loader-container')) {
      // Create and append a loading indicator
      const loader = document.createElement('div');
      loader.className = 'loader-container flex items-center justify-center p-12';
      loader.innerHTML = `
        <div class="inline-block relative w-16 h-16">
          <div class="absolute top-0 left-0 w-full h-full">
            <svg class="animate-spin h-16 w-16 text-marcomm-orange" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </div>
      `;
      
      section.prepend(loader);
    }
  });
}

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
  // Set up dark mode toggle
  setupDarkMode();
  
  // Configure global Chart.js settings for better dark mode support
  configureChartDefaults();
  
  // Add loading indicators to new sections
  addLoadingIndicatorsToNewSections();
  
  // Set up dashboard search
  setupDashboardSearch();
  
  // Set up dashboard navigation
  setupDashboardNav();
  
  // Load dashboard data once
  loadDashboardData();
  
  // Attach refresh event listener
  const refreshButton = getElement('refreshData');
  if (refreshButton) {
    refreshButton.addEventListener('click', function() {
      showDashboardRefreshing();
      loadDashboardData();
    });
  }
  
  // Attach export buttons
  document.querySelectorAll('[data-export-format]').forEach(button => {
    button.addEventListener('click', function() {
      const format = this.getAttribute('data-export-format');
      if (format) {
        exportDashboardData(format);
      }
    });
  });
  
  // Attach print report button
  const printReportButton = document.getElementById('generate-report');
  if (printReportButton) {
    printReportButton.addEventListener('click', function() {
      generatePrintableReport();
      
      // Open print dialog
      setTimeout(() => {
        window.print();
      }, 500);
    });
  }
});

// Add CSS styles for dashboard refreshing animation
const dashboardRefreshingStyle = document.createElement('style');
dashboardRefreshingStyle.textContent = `
  .dashboard-refreshing {
    animation: pulse-bg 1.5s ease-in-out;
  }
  
  @keyframes pulse-bg {
    0% { background-color: transparent; }
    50% { background-color: rgba(255, 107, 53, 0.05); }
    100% { background-color: transparent; }
  }
  
  .dashboard-section {
    transition: opacity 0.3s ease-in-out;
  }
  
  @media print {
    body * {
      visibility: hidden;
    }
    
    #printable-report, #printable-report * {
      visibility: visible;
    }
    
    #printable-report {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
  }
`;
document.head.appendChild(dashboardRefreshingStyle);

                            </script>
</body>
</html>